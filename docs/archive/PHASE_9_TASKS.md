# Phase 9: UI/UX改善＆実用性向上タスクリスト

現場での使い勝手を向上させるための、既存機能のブラッシュアップタスク一覧です。

> **⚠️ 重要: 作業の進め方**
> 本タスクリストの項目を実装する際は、**単に指示通り実装するのではなく、まずその解決策が最適かどうかを検討してください。**
> より良い方法や、潜在的なリスク（例：データの重複保存など）がある場合は、実装前に代替案を提案すること。

---

## 📅 1. 患者一覧・検索（Patient List）

### [1-1] 検索結果に「最終来院日」を追加
- **優先度**: 🔴 高
- **ステータス**: ✅ 完了
- **概要**: 患者検索のドロップダウンリストに、その患者の直近の来院日（または最終記録日）を表示します。
- **目的**: 詳細を開く前に「1週間ぶり」なのか「半年ぶり」なのかを把握し、診療の準備ができるようにするため。

### [1-2] 検索結果に「タグ」を追加
- **優先度**: 🟡 中
- **ステータス**: 未着手
- **概要**: 患者検索リストに、主要なタグ（またはタグの有無を示すバッジ）を表示します。
- **目的**: 「禁忌あり」「VIP」などの重要情報を、詳細を開く前に察知できるようにするため。

---

## 📝 2. カルテ入力・履歴（Clinical Record）

### [2-1] 「前回コピー（Do）」ボタンの実装
- **優先度**: 🔴 高
- **ステータス**: ✅ 完了
- **概要**: カルテ入力フォーム付近にボタンを設置し、クリックすると直近の S/O/A/P 内容を入力欄に転記します。
- **目的**: 定期的なメンテナンスや処方など、前回とほぼ同じ内容の入力時間を劇的に短縮するため。

### [2-2] 履歴リストでの「作成者」視覚化
- **優先度**: 🟢 低
- **ステータス**: 未着手
- **概要**: 施術履歴リスト（RecordList）において、誰が書いた記録か（医師/ナースなど）をアイコンや色枠で区別しやすくします。
- **目的**: スクロールして履歴を見る際、「自分の記録」や「院長の記録」を一瞬で判別できるようにするため。

### [2-3] 「基本情報編集」ボタンの名称変更
- **優先度**: 🟡 中
- **ステータス**: 未着手
- **概要**: プロフィール欄の「編集」ボタンのデザインや文言を「詳細情報の変更」などに変更します。
- **目的**: 今回インライン編集（その場でのタグ・メモ編集）が可能になったため、それらとの機能的な混同を防ぐため。

### [2-4] カルテ記録の削除機能
- **優先度**: 🟡 中
- **ステータス**: ✅ 完了
- **概要**: 各カルテ記録に削除ボタンを設置し、確認ダイアログを経て削除できるようにします（全件対象）。
- **目的**: 誤って作成された記録や、不要なテストデータを整理できるようにするため。土台としての汎用性を重視。

---

## 📅 3. 予約管理（Appointment）

### [3-1] 担当スタッフによる絞り込み機能
- **優先度**: 🟡 中
- **ステータス**: ✅ 完了
- **概要**: 予約一覧ページにプルダウンを追加し、担当スタッフごとに予約を表示フィルターできるようにします。
- **目的**: 複数のスタッフが勤務する場合に、「自分（または特定のスタッフ）の予約」だけを素早く確認するため。

### [3-2] ステータスのアイコン化
- **優先度**: 🔴 高
- **ステータス**: ✅ 完了
- **概要**: リスト上の文字ステータス（完了/予定/キャンセル）を、視認性の高いアイコン（✅, 📅, ❌）に置き換えます。
- **目的**: 文字を読まなくても、パッと見でリストの状況（どれが完了済みで、どれが未消化か）を直感的に認識できるようにするため。

### [3-3] 未アサイン予約のアラート表示
- **優先度**: 🔴 高
- **ステータス**: ✅ 完了
- **概要**: 担当スタッフが「未定(Unassigned)」の予約がある場合、フィルタリング状態に関わらずダッシュボード/リスト上部に警告バッジを表示します（v1.1.2）。
- **目的**: フィルタリングの隙間を埋め、当日の担当漏れ事故を防ぐため。

### [3-6] 事務用申し送りのアラートと連携
- **優先度**: 🔴 高
- **ステータス**: ✅ 完了
- **概要**: 予約データに含まれる「事務用申し送り(Admin Memo)」が未確認の場合、ダッシュボード上部に赤色のアラートを表示。また、リスト上でクリックして確認済みにする機能を追加。
- **目的**: 受付スタッフ間の伝言漏れを防ぎ、タスクの完了状態を可視化するため。

### [3-7] 予約一覧のスクロール最適化
- **優先度**: 🟡 中
- **ステータス**: ✅ 完了
- **概要**: 予約一覧画面のレイアウトを修正し、ヘッダーを固定したままリスト部分のみがスクロールするように改善。
- **目的**: 件数が増えても（全件表示時など）操作性を損なわないようにするため。

### [3-4] キャンセル表示のトーンダウン
- **優先度**: 🟡 中
- **ステータス**: ✅ 完了
- **概要**: 「キャンセル済み(Cancelled)」の予約行を、赤いアイコン(❌)ではなくグレーアウト＋取り消し線で表示します。
- **目的**: 「対応必要なエラー」と誤認されるのを防ぎ、心理的なノイズを減らすため。

### [3-5] 患者削除時の予約自動キャンセル (Integrity)
- **優先度**: 🔴 高
- **ステータス**: ✅ 完了
- **概要**: 患者を削除するServer Actionにおいて、その患者の「未来の予約」のステータスを自動的に `cancelled` に更新するロジックを追加します。
- **目的**: 患者データ消滅後に「幽霊予約」がリストに残るデータの不整合を防ぐため。

---

## 🤖 4. AI取込フロー（AI Import）

### [4-1] 確認画面での直接編集機能
- **優先度**: 🔴 高
- **ステータス**: ✅ 完了
- **概要**: AI解析後の確認画面（プレビュー）を、単なるテキスト表示から編集可能な入力フィールドに変更します。
- **目的**: AIの解析結果に誤字や区切りミスがあった場合、わざわざ元テキストに戻ることなく、その場で修正して登録できるようにするため。

### [4-2] 「既存患者へ移動」アクションの追加
- **優先度**: 🟡 中
- **ステータス**: ✅ 完了
- **概要**: 新規登録時に重複患者が見つかった際のアラート内に、「この患者のカルテ入力へ進む」ボタンを追加します。
- **目的**: 「既に登録済みだった」と判明した際、スムーズに本来の目的（カルテ入力）へ移行できるようにするため。

### [4-3] AI活用ガイド（プロンプト例）の表示
- **優先度**: 🟡 中
- **ステータス**: ✅ 完了
- **概要**: カルテ入力・患者登録のAI取込画面に、生成AI用のプロンプトテンプレートを表示・コピーできるガイドボタンを設置します。
- **目的**: ユーザーが「どのような形式のテキストを用意すればよいか」を迷わず理解し、スムーズにAI連携を行えるようにするため。

---

## 🔒 5. データ管理・アクセス (Admin & Data)

### [5-1] タグ入力および保存の整合性強化
- **優先度**: 🔴 高
- **ステータス**: ✅ 完了
- **概要**: `ConfigForm` のタグ入力とサーバー側 `recordActions` の処理における配列変換の整合性を検証・強化しました。
- **目的**: 複数のタグが確実に保存され、次回編集時にも正しく復元されることを保証するため。

### [5-2] スタッフ管理機能（役割設定の最適化）
- **優先度**: 🔴 高
- **ステータス**: ✅ 完了
- **概要**: 設定画面 `/settings/staff` を新設し、スタッフの追加・無効化を可能にしました。また、役割名を「Doctor/Nurse」から「院長/施術者/受付etc」へ変更しました。
- **目的**: 個人経営の鍼灸・整体院の実態に即した運用を可能にするため。

### [5-3] 予約一覧からカルテ作成への連携
- **優先度**: 🔴 高
- **ステータス**: ✅ 完了
- **概要**: 予約一覧の各行に「カルテ作成」ボタンを設置し、ワンクリックで患者詳細のカルテ入力フォームへスクロール遷移するようにしました。
- **目的**: 「来院確認 → 即座にカルテ入力」というスムーズな診療フローを実現するため。

### [5-4] スタッフ情報の編集機能
- **優先度**: 🟡 中
- **ステータス**: ✅ 完了
- **概要**: スタッフ管理画面にて、登録済みスタッフの名前と役割を編集できる機能を追加しました。
- **目的**: 結婚による改姓や、役割の変更（昇進や兼務など）に柔軟に対応できるようにするため。

### [3-6] 重複予約の防止（Conflict Check）
- **優先度**: 🔴 高
- **ステータス**: ✅ 完了
- **概要**: 予約の新規作成・編集時に、同一スタッフの既存予約と時間が重なる場合にエラーを表示し、保存をブロックするロジックを実装しました。
- **目的**: 物理的に不可能なダブルブッキングをシステム側で確実に防ぎ、予約管理の信頼性を担保するため。

### [3-8] すべての予約ページの履歴表示
- **優先度**: 🟡 中
- **ステータス**: ✅ 完了
- **概要**: 「すべての予約」ページ（/appointments）のデフォルト表示を「過去の履歴を含む」状態に変更。
- **目的**: 予約台帳として機能させるため、過去の履歴も含めた全データを初期状態で確認したいため。

### [3-9] Appointment型定義の整理
- **優先度**: 🔴 高
- **ステータス**: ✅ 完了
- **概要**: `adminMemo`, `isMemoResolved`, `arrivedAt` フィールドに対する `@ts-ignore` を全て解消。Prismaスキーマとの整合性を確保し、型安全性を向上。
- **目的**: コンパイラによる型チェックを有効化し、ランタイムエラーのリスクを軽減するため。
