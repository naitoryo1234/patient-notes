# 📅 Clinic Notebook 計画・仕様変更履歴 (Plan Changelog)

## 📌 目的
本ドキュメントは、Clinic Notebook (Lite CRM) プロジェクトにおける**「仕様・方針の変更履歴」と「意思決定のプロセス」**を記録するものです。
コードの変更履歴（Git Log）とは異なり、「なぜその設計に至ったか」「どのようなフィードバックを受けて方針転換したか」という**文脈（Context）**を残すことを目的としています。

---

## 🕒 バージョン履歴 (Version History)

### v1.6.5: セキュリティアップデート & AI最適化
**日付**: 2025-12-17
**ステータス**: 完了

#### 変更内容
*   **Next.js セキュリティアップデート**:
    *   CVE-2025-55182 (CVSS 10.0: RCE脆弱性) に対応するため、Next.js を 16.0.8 → 16.0.10 に更新。
    *   CVE-2025-55184 (DoS)、CVE-2025-55183 (ソースコード漏洩) も同時に修正。
    *   `eslint-config-next` も 16.0.10 に更新し、ビルド成功を確認。
*   **AI パフォーマンス最適化**:
    *   `.cursorignore` を新規作成し、AIがスキャンする必要のないファイル（ビルド生成物、node_modules、ロックファイル、画像アセット等）を除外設定。
    *   `.gitignore` に Windows/IDE 固有ファイル（Thumbs.db、.idea/）を追加。
*   **分離プロジェクト支援**:
    *   Patient Notes の UI デザインシステムを移植するためのガイド `docs/design/UI_STANDARDS_FOR_HANDOVER.md` を作成。

#### 変更の背景 / 意思決定
*   Vercel から React Server Components の CVE 警告が届いたため、即時対応を実施。
*   分離プロジェクト（Handover Notebook）のリポジトリ作成準備とUI統一のためのドキュメントを整備。
*   Vercel本番（main）は依然としてローカルSQLite設定のためエラーとなるが、デモ用途には `deploy/vercel-demo` ブランチを使用する方針は変更なし。

---

### v1.6.4: 認証機能テスト実施 & プロジェクトテンプレート作成
**日付**: 2025-12-15〜16
**ステータス**: 完了

#### 変更内容
*   **認証機能 (Auth) の動作検証**:
    *   `AUTH_ENABLED=true` 設定後のログイン/ログアウトフローを Browser Automation で検証 (Port 3001)。
    *   セッション維持（リロード後もログイン状態維持）を確認。
    *   操作者追跡（createdBy/担当者が正しく記録される）を確認。
    *   テスト結果を `TEST_PLAN_SETTINGS.md` に記録（AU-01〜03, 05, 06: Pass）。
*   **プロジェクトテンプレートの作成**:
    *   新規プロジェクト用に `_project-template/` フォルダを作成。
    *   AIエージェント運用ファイル（INIT_ROUTER, ガイドライン5種, ワークフロー2種, 設計原則）を汎用化して格納。
    *   `c:\dev\clinic-crm-lite\_project-template` としてコピー完了。

#### 変更の背景 / 意思決定
*   認証機能はLevel 3テストで「条件付きペンディング」としていたが、環境構築後に正常動作を確認。
*   「顧客管理」と「予約管理」を分離した新プロジェクトを開始するにあたり、AIエージェント運用の仕組みを再利用可能な形でテンプレート化した。

---

### v1.6.3: Level 3 テスト実行 (Full Verification)
**日付**: 2025-12-15
**ステータス**: テスト完了

#### 変更内容
*   **Level 3 テスト (Full Verification) の実行**:
    *   Browser Automationを使用し、以下のシナリオを検証:
        *   スタッフ管理 (ST-01〜06): 成功（追加・編集・無効化・有効化）
        *   プラグイン設定 (PL-01〜04): 成功（トグルON/OFF、永続化確認）
        *   バックアップ (BK-01): 成功（ボタン存在確認）
        *   環境依存表示 (ENV-01): 成功（Web版で自動バックアップ非表示）
        *   バリデーション (PT-02): 成功（空送信阻止確認）
        *   長文レイアウト (PT-12): 成功（50文字名で表示確認）
*   **テスト結果の集約**:
    *   L1〜L3で「ついでに確認できていた」暗黙的なPass項目を整理し、各TEST_PLANに反映。
*   **手動確認リスト作成**:
    *   自動化困難な項目（C-06: D&D、BK-01: ファイル中身確認、PT-12: 目視レイアウト確認）を `MANUAL_VERIFICATION_LIST.md` にまとめ。

#### 変更の背景 / 意思決定
*   Level 1/2通過後、メジャーリリース前の全量確認としてLevel 3を実施。
*   Auth機能(AU-xx)やElectron専用機能(BK-02〜08, ENV-02)は、環境制約によりスキップとし「条件付きペンディング」として記録。

---

### v1.6.2: Level 2 テスト実行 (Standard Operations)
**日付**: 2025-12-15
**ステータス**: テスト完了

#### 変更内容
*   **Level 2 テスト (Standard Operations) の実行**:
    *   Browser Automationを使用し、以下のシナリオを検証:
        *   予約変更 (AP-08): 成功
        *   予約キャンセル (AP-11): 成功（List Viewから実行）
        *   重複チェック (AP-14, AP-16): 成功（作成阻止を確認）
        *   ドラッグ&ドロップ (C-06): 自動テスト失敗（手動確認推奨）
        *   新規患者登録 (PT-01): 成功
        *   申し送り登録 (AP-18): 成功
        *   申し送り解決 (AP-19): 成功
        *   ダッシュボードアラート (DA-04): 成功
*   **テスト実施記録の更新**:
    *   各 `TEST_PLAN_*.md` に実施結果を記録。

#### 変更の背景 / 意思決定
*   Level 1 (Core Flow) 通過後、業務網羅レベルの検証としてLevel 2を実施。
*   ドラッグ&ドロップの自動テストは技術的制約により失敗したが、機能自体は以前のセッションで手動確認済み。

---

### v1.6.1: テスト仕様書整備
**日付**: 2025-12-15
**ステータス**: 実装完了

#### 変更内容
*   **テスト仕様書の作成**:
    *   システム全体の128件のテストシナリオを6種類のテスト仕様書に整理。
    *   docs/tests/ フォルダを新設し、TEST_PLAN_*.md を移動・整備。
*   **テスト実行ガイドの作成**:
    *   Level 1 (Core Flow) / Level 2 (Standard Operations) / Level 3 (Full Verification) の3段階のテスト実行戦略を定義。
*   **テスト結果記録形式の追加**:
    *   各仕様書に「テスト実施記録」セクションを追加。ID/結果/日時/実施者/備考を記録可能に。
*   **Level 1 テスト実行 (Browser Automation)**:
    *   予約作成 → カレンダー確認 → チェックイン → カルテ作成 → 完了 の一連フローを自動テストで検証し、Passを確認。

#### 変更の背景 / 意思決定
*   品質保証のため、機能ごとのテストシナリオを体系的に整理する必要があった。
*   テスト実施履歴を残すことで、いつ誰がどのバージョンをテストしたかを追跡可能にした。
*   Browser Subagentを活用し、ブラウザ操作の自動化によるリグレッションテストの基盤を構築した。

---

### v1.6.0: 実務適合性強化 (担当者フィルタ・設定永続化)
**日付**: 2025-12-14
**ステータス**: 実装完了

#### 変更内容
*   **担当者フィルタリング**:
    *   カレンダー画面上部に担当者選択ドロップダウンを追加。
    *   特定のスタッフ（または担当なし）の予約のみを表示する機能を実装。
*   **表示設定の永続化**:
    *   カレンダー/台帳の表示モード切り替え（List vs Calendar）をブラウザのLocalStorageに保存。
    *   リロードしても前回の表示モードが維持されるように改善。
*   **予約詳細表示の強化**:
    *   `WeekView` の予約カード内に `memo` (施術内容など) を表示するスペースを追加。
    *   視認性を損なわないよう1行でtruncateして表示。
    *   予約カードへのホバー時、患者名・フリガナ・未解決の「申し送り」・「メモ」をツールチップ表示する機能を追加。

#### 変更の背景 / 意思決定
*   スタッフ数が増えた際、全員分の予約が表示されると視認性が下がるため、フィルタリング機能を導入した。
*   「毎回カレンダーボタンを押すのが面倒」というUX課題を解決するため、設定を永続化した。
*   予約枠を見ただけで「カットなのかカラーなのか」を判別したいという要望に応え、メモ表示を追加した。

---

### v1.5.2: カレンダー視認性向上 & 重複表示対応
**日付**: 2025-12-14
**ステータス**: 実装完了

#### 変更内容
*   **重複予約の並列表示 (Overlap Layout)**:
    *   `WeekView` において、同じ時間帯に予約が重なる場合、自動的に列を分割して並列表示するロジックを実装。
    *   これにより、担当者が異なる同時刻予約が重なって見えなくなる問題を解決。
*   **担当者色分け (Staff Color Coding)**:
    *   スタッフIDに基づき、予約カードの左ボーダー色を自動的に割り当てる機能を実装（WeekView/MonthView共）。
    *   背景色は「ステータス（来院済み・完了など）」、枠色は「担当者」と役割を分担させ、視認性を大幅に向上。
*   **カレンダー操作性の最適化**:
    *   `MonthView` でのドラッグ＆ドロップを無効化（誤操作防止のため閲覧専用化）。
    *   `WeekView` ではドラッグ＆ドロップを維持し、さらに「予約カードの上」へのドロップを可能にした（既存予約との重なり対応）。

#### 変更の背景 / 意思決定
*   複数スタッフでの運用時、予約が重なって操作不能になる致命的な問題に対処する必要があったため。
*   「誰の予約か」の判別を容易にするため、色分けの要望を採用。データのスキーマ変更を避けるため、フロントエンド側での動的カラー割り当てを選択した。

---

### v1.5.1: カレンダービュー & DnD機能 (Calendar Impl)
**日付**: 2025-12-14
**ステータス**: 実装完了

#### 変更内容
*   **カレンダービュー実装**:
    *   `/appointments` ページに「月表示」と「週表示」の切り替えタブを追加。
    *   予約状況をグリッド形式で可視化し、空き枠の確認を容易にした。
*   **ドラッグ＆ドロップ編集**:
    *   予約カードをドラッグして別の日付へ移動する機能を実装（時間は維持）。
    *   認証状態チェックに加え、開発モード（`AUTH_ENABLED=false`）での動作許可ルールを追加。
*   **UI/UX改善**:
    *   カレンダーグリッド内のスクロール対応（ヘッダー固定）。
    *   URLパラメータ (`?date=yyyy-mm-dd`) による初期表示日付指定の実装。

#### 変更の背景 / 意思決定
*   従来のリスト表示のみでは「空き状況」の把握が困難であったため、視覚的なマトリックス表示（カレンダー）を導入。
*   日時変更の手間を減らすため DnD を採用したが、データの整合性を保つためサーバーサイドのバリデーションとキャッシュ更新（`revalidatePath`）を徹底した。

---

### v1.5.0: 統合予約モーダル & 予約台帳UX改善
**日付**: 2025-12-14
**ステータス**: 実装完了

#### 変更内容
*   **統合予約モーダルの実装 (`AppointmentFormModal.tsx`)**:
    *   従来分散していた「新規作成」「編集」「複製」のためのモーダルを1つのコンポーネントに統合。
    *   全機能（患者選択、日時・所要時間、担当者、メモ）を共通化し、一貫したUI/UXを提供。
*   **予約管理台帳のUX改善 (`DailyAppointmentPanel.tsx`)**:
    *   **参照モード**: 予約一覧ページ(`/appointments`)での利用時、カードクリックでリストをフィルタリングするモードを追加。ヘッダー色変更とバッジ表示で視覚的に区別。
    *   **時間経過ロジックの改善**: 当日の予約時間が過ぎても、完了処理が行われるまではリストに残るよう仕様変更。アクションボタン（チェックイン/完了）も維持。

#### 変更の背景 / 意思決定
*   メンテナンス性とUX向上のため、類似コードが分散していた予約モーダルを統合した。
*   予約一覧ページにおいて、左側のパネルがダッシュボードと同じ挙動（詳細表示）だと使い勝手が悪いため、検索フィルタとして機能するように役割を変更した。
*   実務上、時間が過ぎてから完了処理を行うケースが多いため、自動的にリストから消える仕様を廃止した。

---

### v1.4.2: 自動バックアップ・復元機能 & アイコン設定
**日付**: 2025-12-14
**ステータス**: 実装完了

#### 変更内容
*   **自動バックアップ機能**:
    *   アプリ起動時・終了時に自動でバックアップを作成。
    *   最新10件を保持するローテーション機能を実装。
    *   `main/backup.js` にロジックを集約し、ファイル名から日時をパースする方式でメタデータ問題を解決。
*   **バックアップ復元機能 (Electron専用)**:
    *   設定画面に「自動バックアップ管理」UIを追加（Electron環境のみ表示）。
    *   バックアップ一覧からのワンクリック復元（確認ダイアログ付き）。
    *   復元前に自動で安全バックアップ(`pre-restore-*.db`)を作成する安全設計。
    *   復元完了後にアプリを自動再起動するワークフローを確立。
*   **ブランディング**:
    *   パッケージ名を `customer-notebook` に変更し、`userData` パスを適正化。
    *   アプリアイコン候補を生成・保存。

#### 変更の背景 / 意思決定
*   Electronアプリ化に伴い、ユーザー自身でのデータ保全が重要となるため、バックアップ/復元を最優先機能として実装。
*   ファイル更新日時(mtime)はビルド時にリセットされることが判明したため、ファイル名から日時を取得する堅牢な実装に変更した。

---

### v1.4.1: Electron + Next.js 統合完了
**日付**: 2025-12-14
**ステータス**: 実装完了

#### 変更内容
*   **内蔵サーバー方式の採用**:
    *   Next.jsの`output: 'standalone'`を有効化し、自己完結型ビルドを生成。
    *   Electronメインプロセスから`child_process.spawn`でNext.jsサーバーを起動。
    *   Server Actionsをそのまま使用可能（IPC通信への書き換え不要）。
*   **問題解決**:
    *   ホスト名問題(`HOSTNAME=localhost`環境変数で解決)
    *   静的ファイル配置（ビルド後にstatic/publicをstandalone内にコピー）
    *   preload.jsの作成
    *   winCodeSign手動ダウンロード対応
*   **ドキュメント化**:
    *   `docs/technical/ELECTRON_NEXTJS_GUIDE.md` に技術ガイドを作成。

#### 変更の背景 / 意思決定
*   Static Export (`output: 'export'`)ではServer Actionsが使用できないため却下。
*   IPC通信への書き換えは工数が大きすぎるため、内蔵サーバー方式を採用。
*   ユーザーのPCにNode.jsがインストールされている前提で、パッケージサイズを最小限に抑えた。

---

### v1.4.0: プラグイン設定管理 & 配布戦略策定
**日付**: 2025-12-13
**ステータス**: 実装完了

#### 変更内容
*   **動的設定管理の実装**:
    *   `SystemSetting` テーブルを新規作成し、Key-Value形式で設定を保持。
    *   システム設定画面に「プラグイン設定」セクションを追加し、UIから画像添付機能のON/OFFが可能に。
    *   変更は即座に反映され、環境変数(`NEXT_PUBLIC_...`)よりもDB設定が優先される仕組みを構築。
*   **配布戦略の策定**:
    *   SaaS型(Vercel)とローカル型(Electron)のハイブリッド展開方針を決定。
    *   `DISTRIBUTION_STRATEGY.md` を作成し、それぞれの対象ユーザーと技術要件を定義。
*   **堅牢化**:
    *   `src/lib/prisma.ts` シングルトンを導入し、開発時の接続エラーを防止。

#### 変更の背景 / 意思決定
*   ローカル配布（Electron）時、ユーザーが環境変数を編集するのは困難であるため、アプリ内設定UIが必須と判断。
*   「環境変数はデフォルト値、DB設定はオーバーライド」という優先順位にすることで、既存のクラウド環境との互換性を保ちつつ柔軟性を確保した。

---

### v1.3.2: 画像添付プラグイン & GENERIC化完成
**日付**: 2025-12-13
**ステータス**: 実装完了

#### 変更内容
*   **画像添付プラグイン**:
    *   `src/plugins/attachments/` にプラグイン構造を新規作成。
    *   記録カードに📷ボタン → モーダルで画像アップロード。
    *   サムネイル表示、拡大表示、削除機能。
    *   `NEXT_PUBLIC_ATTACHMENTS_ENABLED=true` で有効化。
    *   `next.config.ts` にbodySizeLimit: 10MBを設定。
*   **GENERIC化の漏れ修正**:
    *   UIテキストの医療固有語を一般化（「カルテ」→「記録」、「患者様」→「お客様」等）。
*   **タイトル変更**:
    *   「Clinic Notebook」→「Customer Notebook」、アイコン「🩺」→「📋」。

#### 変更の背景 / 意思決定
*   プラグイン方式採用: 記録作成フローには組み込まず、「後から追加」形式でシンプルさを維持。
*   設定UIは未実装（配布方法決定後に検討）。現時点では環境変数で切替。

---

### v1.3.1: 汎用化 (Generalization) - GENERICプリセット導入
**日付**: 2025-12-13
**ステータス**: 実装完了

#### 変更内容
*   **GENERICプリセットの導入**:
    *   `labels.ts`を完全再設計。GENERICをベースとし、CLINIC/SALONは差分のみ定義する構造に変更。
    *   デフォルトをGENERICに設定（お客様、記録、来店 等の汎用表現）。
*   **AI取込ガイドの改善**:
    *   「シンプル版/詳細版」を廃止し、統合プロンプトに集約。
    *   出力安定化のためコードブロック出力ルールを明示。
*   **ハードコードの変数化**:
    *   新規登録ページ、フォーム設定、AI取込ガイドの例文を全てTERMS変数に移行。
    *   業態別のタグオプション、例文も設定で切り替え可能に。

#### 変更の背景 / 意思決定
*   AI開発環境を活用した「業態別カスタム版作成」を容易にするため、ベースを汎用化。
*   設定ファイル変更のみで業態対応が完了する構造を目指した。
*   次のステップとして「記録フォームの設定駆動化（案C）」を検討中。

---

### v1.3.0: 認証・操作者追跡機能 (Auth & Operator Tracking)
**日付**: 2025-12-13
**ステータス**: 実装完了

#### 変更内容
*   **PIN認証ログイン**:
    *   環境変数 `AUTH_ENABLED` でON/OFF切替可能な認証機能を実装。
    *   ログイン時にスタッフを選択し、操作者として記録。
    *   ヘッダーにログインユーザー名とログアウトボタンを表示。
*   **操作者追跡 (Operator Tracking)**:
    *   申し送り解決時: 解決者ID (`adminMemoResolvedBy`) と日時を記録・表示。
    *   予約作成/更新時: `createdBy` / `updatedBy` をDBに記録。
    *   カルテ作成時: 記録者と記録日時を常に表示（設計原則に従い）。
*   **設計原則ドキュメント (`DESIGN_PRINCIPLES.md`) の導入**:
    *   「記録の透明性」「汎用性」「明示性」の3原則を定義。
    *   セッションハンドオーバー時に参照するよう運用を更新。

#### 変更の背景 / 意思決定
*   「誰が・いつ」の情報は業種を問わず記録システムの基本仕様であり、表示しない理由がないと判断。
*   特定業種（医療等）に最適化しすぎず、汎用的なビジネス記録システムとしても成立する設計を目指した。

---

### v1.1.5: アラート文言の明確化（スコープ区別）
**日付**: 2025-12-11
**ステータス**: 実装完了

#### 変更内容
*   **申し送りアラートの文言改善**:
    *   ダッシュボード: 「未確認の申し送り事項が X件」→ 「**本日の**未確認申し送り: X件」
    *   予約一覧: 「未確認の申し送り事項が X件」→ 「**すべての**未確認申し送り: X件」

#### 変更の背景 / 意思決定
*   ダッシュボード（本日のみ）と予約一覧（全期間）で同じ文言を使うと、件数の違いに混乱が生じるため。
*   スコープ（本日 vs 全体）を明示することで、各画面の役割が一目瞭然になり、運用上の混乱を防ぐ。

### v1.1.4: 型定義整理 & コード品質向上
**日付**: 2025-12-11
**ステータス**: 実装完了

#### 変更内容
*   **@ts-ignore の完全排除**:
    *   `appointmentService.ts`, `AppointmentListClient.tsx`, `DailyAppointmentPanel.tsx` 等、計10箇所以上に残っていた `@ts-ignore` を全て削除。
    *   Prismaスキーマに正式に定義されている `adminMemo`, `isMemoResolved`, `arrivedAt` フィールドを、型定義に正しく反映。
*   **recordService.ts の修正**:
    *   カルテ作成時の `staffId` が必須であることをサービスレイヤーで明示的にバリデート。

#### 変更の背景 / 意思決定
*   型安全性を高め、TypeScriptコンパイラによるエラー検出を最大限に活用するため。
*   `@ts-ignore` は一時的なワークアラウンドとして使用されていたが、スキーマが確定したため正式に解消した。

### v1.1.3: 事務用申し送り強化 & リスト操作性改善
**日付**: 2025-12-11
**ステータス**: 実装完了

#### 変更内容
*   **事務用申し送り (Admin Memo) の運用強化**:
    *   未確認の申し送りがある場合、ダッシュボードおよび予約一覧の上部に「赤色のアラート」を表示。
    *   予約一覧リスト内で申し送り内容を表示し、クリック一つで「確認済み/未確認」をトグルできる機能を追加。
*   **予約一覧 (Appointment List) のUI改善**:
    *   リスト部分のみがスクロールするようレイアウトを修正（ヘッダー固定）。
    *   「過去の予約」をデフォルトで表示する仕様（台帳モード）に変更。
    
#### 変更の背景 / 意思決定
*   「申し送りを書いたが見落とされる」という課題に対し、視覚的なアラートと消込アクションを導入して確実に伝達するため。
*   予約一覧を「台帳」として使いたいというニーズに応え、デフォルトで全履歴を表示するようにした。

### v1.1.2: 来院チェックイン機能 (Check-in System)
**日付**: 2025-12-11 15:24
**ステータス**: 実装完了

#### 変更内容
*   **来院管理の実装**:
    *   `Appointment` モデルに `arrivedAt` (来院日時) を追加。
    *   ダッシュボード上で「受付」ボタンを押すと、ステータスが `arrived` に変わり、カードの視認性が変化するようになった。
*   **運用シナリオ適合化**:
    *   [OPERATIONAL_SCENARIOS.md](cci:7://file:///c:/dev/clinic-crm-lite/patient-notes/docs/specs/OPERATIONAL_SCENARIOS.md:0:0-0:0) の「2-1. 来院チェックイン」の要件を満たす実装を完了。

#### 変更の背景 / 意思決定
*   「汎用的な土台」として、単なる予約枠の消化だけでなく「いつ来院したか」の記録は必須であると判断したため。
*   ダッシュボードが「待合室の状況把握」の役割も担えるようになった。

### v1.2.0-Alpha: Phase 10 スコープ定義 (Launch Pad)
**日付**: 2025-12-10 (Review)
**ステータス**: スコープ調整完了

#### 変更内容
*   **Phase 10 再定義**:
    *   当初計画されていた「AIサマリー」「LINE連携」などの高度な機能を `IDEAS.md` (Archived) へ移動・保留。
    *   代わりに「文言の変数化（ラベル定義）」と「バックアップ（データエクスポート）」を Phase 10 の主要タスクとして設定。
*   **実用化へのフォーカス**:
    *   「多機能なアプリ」ではなく、「配布・導入しやすい汎用Base Kit」としての完成度を高める方針を確定。

#### 変更の背景 / 意思決定
*   高度なAI/通知機能は外部依存性が強く、ローカル完結型である「Base Kit」のコンセプト（配布・インストールの容易さ）と競合するため。
*   まずは「名前を変えれば他の業種でも使える」状態 (Generic) を目指すことが最優先と判断されたため。

### v1.1.1: 運用リアリティの追求 (Operational Reality)
**日付**: 2025-12-11
**ステータス**: 運用適合性修正

#### 変更内容
*   **予約担当者の任意化 (Rollback)**:
    *   一度実装した「予約担当者の必須化」を撤回し、実務運用に合わせて「調整可能（Optional）」な仕様に戻した。
    *   「担当未定」の状態をシステム上で許容し、UI上の強調表示（警告色・アイコン）でカバーする方針へ転換。
*   **実務運用シナリオの策定**:
    *   機能実装に先立ち「実務運用シナリオ (`OPERATIONAL_SCENARIOS.md`)」を策定するプロセスを導入。
*   **ダッシュボードの機能強化**:
    *   本日の予約パネルに「診察券番号検索」と「1分間隔の自動更新」を追加し、受付業務のリアルタイム性を向上。

#### 変更の背景 / 意思決定
*   現場（鍼灸・整体院等）では「まず予約を受け、担当は後で調整する」運用が一般的であり、システムによる強制が業務ブロッカーになると判断したため。
*   「正しいデータ」よりも「柔軟な運用」を優先し、アラート機能でミスを防ぐ設計を選択した。

### v1.1.0: 鍼灸・整体院向け最適化 & 予約高度化 (Phase 9 Update)
**日付**: 2025-12-10 〜 2025-12-11
**ステータス**: 実用性向上アップデート

#### 変更内容
*   **スタッフ役割の再定義**: 病院向けの `Doctor/Nurse` という呼称を廃止し、`Director` (院長) / `Therapist` (施術者) / `Clerk` (受付) に変更。
*   **予約・カルテ連携の強化**: 予約一覧から「カルテ作成」への直接遷移ボタンを実装。
*   **予約時間管理の変更 (重要)**:
    *   `Appointment` モデルで `duration` (所要時間) を利用開始（初期値60分）。
    *   予約作成・変更時に「所要時間」を選択できるようにし、重複チェックの精度を向上。
*   **安全性の向上**: タグ入力のデータ整合性検証、および `ConfigForm` のバリデーション強化。

#### 変更の背景 / 意思決定
*   ユーザーからの「個人経営の鍼灸院や整体院をターゲットにするため、役割名を無難なものに変更したい」という要望を反映。
*   「30分枠と60分枠が混在する現場」において、単純な開始時間の一致だけでは重複を防げないため、所要時間を明示的に扱う方針へ変更した。
*   「予約を確認してすぐカルテを書く」という現場のワークフローに即した導線改善を実施。

### v1.0.1: フェーズ境界プロトコルとBase Kit定義
**日付**: 2025-12-10
**ステータス**: 運用ルール確立 / Phase 8 仕切り直し

#### 変更内容
*   **運用ルールの厳格化**: `RESTRICTIONS.md` に「合意なき機能拡張の禁止」を追加。
*   **状態のロールバック**: 試験的に導入した画像アップロード機能を完全に Revert し、「汎用Base Kit」としてのクリーンな状態を確立。
*   **次フェーズのプロセス定義**: 機能追加（Phase 8）は必ず「機能選択の合意形成」を経てから行うプロセスを策定。

#### 変更の背景
*   AI主導で機能を作り込みすぎると、ユーザーの実際のオペレーションと乖離するリスクがあるため。
*   「何でもできる」状態よりも「必要なものだけがある」状態を維持する方針を明確にした。

---

### v1.0.0: プロトタイプ仕様固定と堅牢化 (Current)
**日付**: 2025-12-10
**ステータス**: 仕様書策定完了 / Phase 7 実装完了

#### 変更内容
*   **外部AIレビュー（Gemini 3.0 Pro / Claude 3.5 Sonnet）の統合と反映**。
*   Prismaスキーマの大幅な安全性強化:
    *   `ClinicalRecord` の `staffId` を必須化（責任所在の明確化）。
    *   `Patient` 削除時の制約を `Cascade` から `Restrict` に変更（誤削除防止）。
    *   `deletedAt` カラムの追加（論理削除の導入）。
    *   `Appointment` に `duration` を追加（重複検知の準備）。
    *   `Attachment` のパスを `storageKey` に変更（クラウド移行準備）。
*   **仕様書 (`SPEC_V1_DRAFT.md`) の確定**:
    *   バックアップ運用方針を「稼働中コピー禁止」に修正。
    *   認証機能の実装を「v1.0 必須要件」へ格上げ。

#### 変更の背景 / 意思決定
*   プロトタイプとして機能は揃ったが、外部AIレビューにより「医療記録システムとしてのデータ保全・監査性が不十分」との指摘を受けたため。
*   特に「SQLiteのバックアップ破損リスク」や「スタッフ不明のカルテ問題」は、リリース後の致命傷になり得るため、仕様策定フェーズで緊急対応した。

---

### v0.9.0: 仕様書ドラフト作成とフェーズ再定義
**日付**: 2025-12-10
**ステータス**: プロトタイプ実装一巡

#### 変更内容
*   開発フェーズ定義の更新:
    *   Phase 7 までを「プロトタイプ(MVP)」として区切り、ここで一旦仕様書を起こす方針へ変更。
    *   Phase 8 以降（画像機能など）を「拡張フェーズ」とし、仕様固定後に着手することにした。
*   `v1.0 仕様書ドラフト` の新規作成。
*   `Staff` 管理機能の初期実装（DBモデル追加、シードデータ投入）。
*   次回予約・カルテ連携の実装（UI上の統合）。

#### 変更の背景 / 意思決定
*   機能実装先行で進んできた結果、「見えない仕様（重複チェックロジックなど）」が増加し、ドキュメントなしでの拡張に限界を感じたため。
*   「CRUDアプリ」から「業務システム」への脱皮を図るため、まずは骨格（DBスキーマ）を固める必要があった。

---

### v0.5.0: 予約管理の独立とUI強化
**日付**: 2025-12-10 (Early)
**ステータス**: 基本機能実装中

#### 変更内容
*   **データモデル変更**:
    *   `ClinicalRecord` 内の日付管理から、独立した `Appointment` モデルへの分離。
    *   これにより「予約」と「実施記録」を別管理する一般的なCRM構造へ移行。
*   **UI/UX**:
    *   ダッシュボードに「本日の来院予定パネル」を追加。
    *   直近1時間のハイライトなど、現場での視認性を意識した改修。

#### 変更の背景 / 意思決定
*   初期構想ではカルテ＝予約日時だったが、「予約変更」や「キャンセル」の履歴管理、および「予約枠としての管理」を行うにはモデル分離が不可欠と判断したため。

---

### v0.1.0: プロジェクト初期化
**日付**: 2025-12-09
**ステータス**: 初期セットアップ

#### 変更内容
*   Next.js + Prisma + SQLite による基盤構築。
*   `Patient` (患者) と `ClinicalRecord` (カルテ) の基本CRUD実装。
*   AIテキスト取込機能（Beta）のPoC実装。

#### 変更の背景 / 意思決定
*   「一人院長のための第2の脳」というコンセプトに基づき、まずは手入力の負担を減らすAI連携をコア価値として検証するため。
