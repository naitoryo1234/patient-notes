# 📅 Clinic Notebook 計画・仕様変更履歴 (Plan Changelog)

## 📌 目的
本ドキュメントは、Clinic Notebook (Lite CRM) プロジェクトにおける**「仕様・方針の変更履歴」と「意思決定のプロセス」**を記録するものです。
コードの変更履歴（Git Log）とは異なり、「なぜその設計に至ったか」「どのようなフィードバックを受けて方針転換したか」という**文脈（Context）**を残すことを目的としています。

---

## 🕒 バージョン履歴 (Version History)

### v1.4.1: Electron + Next.js 統合完了
**日付**: 2025-12-14
**ステータス**: 実装完了

#### 変更内容
*   **内蔵サーバー方式の採用**:
    *   Next.jsの`output: 'standalone'`を有効化し、自己完結型ビルドを生成。
    *   Electronメインプロセスから`child_process.spawn`でNext.jsサーバーを起動。
    *   Server Actionsをそのまま使用可能（IPC通信への書き換え不要）。
*   **問題解決**:
    *   ホスト名問題(`HOSTNAME=localhost`環境変数で解決)
    *   静的ファイル配置（ビルド後にstatic/publicをstandalone内にコピー）
    *   preload.jsの作成
    *   winCodeSign手動ダウンロード対応
*   **ドキュメント化**:
    *   `docs/technical/ELECTRON_NEXTJS_GUIDE.md` に技術ガイドを作成。

#### 変更の背景 / 意思決定
*   Static Export (`output: 'export'`)ではServer Actionsが使用できないため却下。
*   IPC通信への書き換えは工数が大きすぎるため、内蔵サーバー方式を採用。
*   ユーザーのPCにNode.jsがインストールされている前提で、パッケージサイズを最小限に抑えた。

---

### v1.4.0: プラグイン設定管理 & 配布戦略策定
**日付**: 2025-12-13
**ステータス**: 実装完了

#### 変更内容
*   **動的設定管理の実装**:
    *   `SystemSetting` テーブルを新規作成し、Key-Value形式で設定を保持。
    *   システム設定画面に「プラグイン設定」セクションを追加し、UIから画像添付機能のON/OFFが可能に。
    *   変更は即座に反映され、環境変数(`NEXT_PUBLIC_...`)よりもDB設定が優先される仕組みを構築。
*   **配布戦略の策定**:
    *   SaaS型(Vercel)とローカル型(Electron)のハイブリッド展開方針を決定。
    *   `DISTRIBUTION_STRATEGY.md` を作成し、それぞれの対象ユーザーと技術要件を定義。
*   **堅牢化**:
    *   `src/lib/prisma.ts` シングルトンを導入し、開発時の接続エラーを防止。

#### 変更の背景 / 意思決定
*   ローカル配布（Electron）時、ユーザーが環境変数を編集するのは困難であるため、アプリ内設定UIが必須と判断。
*   「環境変数はデフォルト値、DB設定はオーバーライド」という優先順位にすることで、既存のクラウド環境との互換性を保ちつつ柔軟性を確保した。

---

### v1.3.2: 画像添付プラグイン & GENERIC化完成
**日付**: 2025-12-13
**ステータス**: 実装完了

#### 変更内容
*   **画像添付プラグイン**:
    *   `src/plugins/attachments/` にプラグイン構造を新規作成。
    *   記録カードに📷ボタン → モーダルで画像アップロード。
    *   サムネイル表示、拡大表示、削除機能。
    *   `NEXT_PUBLIC_ATTACHMENTS_ENABLED=true` で有効化。
    *   `next.config.ts` にbodySizeLimit: 10MBを設定。
*   **GENERIC化の漏れ修正**:
    *   UIテキストの医療固有語を一般化（「カルテ」→「記録」、「患者様」→「お客様」等）。
*   **タイトル変更**:
    *   「Clinic Notebook」→「Customer Notebook」、アイコン「🩺」→「📋」。

#### 変更の背景 / 意思決定
*   プラグイン方式採用: 記録作成フローには組み込まず、「後から追加」形式でシンプルさを維持。
*   設定UIは未実装（配布方法決定後に検討）。現時点では環境変数で切替。

---

### v1.3.1: 汎用化 (Generalization) - GENERICプリセット導入
**日付**: 2025-12-13
**ステータス**: 実装完了

#### 変更内容
*   **GENERICプリセットの導入**:
    *   `labels.ts`を完全再設計。GENERICをベースとし、CLINIC/SALONは差分のみ定義する構造に変更。
    *   デフォルトをGENERICに設定（お客様、記録、来店 等の汎用表現）。
*   **AI取込ガイドの改善**:
    *   「シンプル版/詳細版」を廃止し、統合プロンプトに集約。
    *   出力安定化のためコードブロック出力ルールを明示。
*   **ハードコードの変数化**:
    *   新規登録ページ、フォーム設定、AI取込ガイドの例文を全てTERMS変数に移行。
    *   業態別のタグオプション、例文も設定で切り替え可能に。

#### 変更の背景 / 意思決定
*   AI開発環境を活用した「業態別カスタム版作成」を容易にするため、ベースを汎用化。
*   設定ファイル変更のみで業態対応が完了する構造を目指した。
*   次のステップとして「記録フォームの設定駆動化（案C）」を検討中。

---

### v1.3.0: 認証・操作者追跡機能 (Auth & Operator Tracking)
**日付**: 2025-12-13
**ステータス**: 実装完了

#### 変更内容
*   **PIN認証ログイン**:
    *   環境変数 `AUTH_ENABLED` でON/OFF切替可能な認証機能を実装。
    *   ログイン時にスタッフを選択し、操作者として記録。
    *   ヘッダーにログインユーザー名とログアウトボタンを表示。
*   **操作者追跡 (Operator Tracking)**:
    *   申し送り解決時: 解決者ID (`adminMemoResolvedBy`) と日時を記録・表示。
    *   予約作成/更新時: `createdBy` / `updatedBy` をDBに記録。
    *   カルテ作成時: 記録者と記録日時を常に表示（設計原則に従い）。
*   **設計原則ドキュメント (`DESIGN_PRINCIPLES.md`) の導入**:
    *   「記録の透明性」「汎用性」「明示性」の3原則を定義。
    *   セッションハンドオーバー時に参照するよう運用を更新。

#### 変更の背景 / 意思決定
*   「誰が・いつ」の情報は業種を問わず記録システムの基本仕様であり、表示しない理由がないと判断。
*   特定業種（医療等）に最適化しすぎず、汎用的なビジネス記録システムとしても成立する設計を目指した。

---

### v1.1.5: アラート文言の明確化（スコープ区別）
**日付**: 2025-12-11
**ステータス**: 実装完了

#### 変更内容
*   **申し送りアラートの文言改善**:
    *   ダッシュボード: 「未確認の申し送り事項が X件」→ 「**本日の**未確認申し送り: X件」
    *   予約一覧: 「未確認の申し送り事項が X件」→ 「**すべての**未確認申し送り: X件」

#### 変更の背景 / 意思決定
*   ダッシュボード（本日のみ）と予約一覧（全期間）で同じ文言を使うと、件数の違いに混乱が生じるため。
*   スコープ（本日 vs 全体）を明示することで、各画面の役割が一目瞭然になり、運用上の混乱を防ぐ。

### v1.1.4: 型定義整理 & コード品質向上
**日付**: 2025-12-11
**ステータス**: 実装完了

#### 変更内容
*   **@ts-ignore の完全排除**:
    *   `appointmentService.ts`, `AppointmentListClient.tsx`, `DailyAppointmentPanel.tsx` 等、計10箇所以上に残っていた `@ts-ignore` を全て削除。
    *   Prismaスキーマに正式に定義されている `adminMemo`, `isMemoResolved`, `arrivedAt` フィールドを、型定義に正しく反映。
*   **recordService.ts の修正**:
    *   カルテ作成時の `staffId` が必須であることをサービスレイヤーで明示的にバリデート。

#### 変更の背景 / 意思決定
*   型安全性を高め、TypeScriptコンパイラによるエラー検出を最大限に活用するため。
*   `@ts-ignore` は一時的なワークアラウンドとして使用されていたが、スキーマが確定したため正式に解消した。

### v1.1.3: 事務用申し送り強化 & リスト操作性改善
**日付**: 2025-12-11
**ステータス**: 実装完了

#### 変更内容
*   **事務用申し送り (Admin Memo) の運用強化**:
    *   未確認の申し送りがある場合、ダッシュボードおよび予約一覧の上部に「赤色のアラート」を表示。
    *   予約一覧リスト内で申し送り内容を表示し、クリック一つで「確認済み/未確認」をトグルできる機能を追加。
*   **予約一覧 (Appointment List) のUI改善**:
    *   リスト部分のみがスクロールするようレイアウトを修正（ヘッダー固定）。
    *   「過去の予約」をデフォルトで表示する仕様（台帳モード）に変更。
    
#### 変更の背景 / 意思決定
*   「申し送りを書いたが見落とされる」という課題に対し、視覚的なアラートと消込アクションを導入して確実に伝達するため。
*   予約一覧を「台帳」として使いたいというニーズに応え、デフォルトで全履歴を表示するようにした。

### v1.1.2: 来院チェックイン機能 (Check-in System)
**日付**: 2025-12-11 15:24
**ステータス**: 実装完了

#### 変更内容
*   **来院管理の実装**:
    *   `Appointment` モデルに `arrivedAt` (来院日時) を追加。
    *   ダッシュボード上で「受付」ボタンを押すと、ステータスが `arrived` に変わり、カードの視認性が変化するようになった。
*   **運用シナリオ適合化**:
    *   [OPERATIONAL_SCENARIOS.md](cci:7://file:///c:/dev/clinic-crm-lite/patient-notes/docs/specs/OPERATIONAL_SCENARIOS.md:0:0-0:0) の「2-1. 来院チェックイン」の要件を満たす実装を完了。

#### 変更の背景 / 意思決定
*   「汎用的な土台」として、単なる予約枠の消化だけでなく「いつ来院したか」の記録は必須であると判断したため。
*   ダッシュボードが「待合室の状況把握」の役割も担えるようになった。

### v1.2.0-Alpha: Phase 10 スコープ定義 (Launch Pad)
**日付**: 2025-12-10 (Review)
**ステータス**: スコープ調整完了

#### 変更内容
*   **Phase 10 再定義**:
    *   当初計画されていた「AIサマリー」「LINE連携」などの高度な機能を `IDEAS.md` (Archived) へ移動・保留。
    *   代わりに「文言の変数化（ラベル定義）」と「バックアップ（データエクスポート）」を Phase 10 の主要タスクとして設定。
*   **実用化へのフォーカス**:
    *   「多機能なアプリ」ではなく、「配布・導入しやすい汎用Base Kit」としての完成度を高める方針を確定。

#### 変更の背景 / 意思決定
*   高度なAI/通知機能は外部依存性が強く、ローカル完結型である「Base Kit」のコンセプト（配布・インストールの容易さ）と競合するため。
*   まずは「名前を変えれば他の業種でも使える」状態 (Generic) を目指すことが最優先と判断されたため。

### v1.1.1: 運用リアリティの追求 (Operational Reality)
**日付**: 2025-12-11
**ステータス**: 運用適合性修正

#### 変更内容
*   **予約担当者の任意化 (Rollback)**:
    *   一度実装した「予約担当者の必須化」を撤回し、実務運用に合わせて「調整可能（Optional）」な仕様に戻した。
    *   「担当未定」の状態をシステム上で許容し、UI上の強調表示（警告色・アイコン）でカバーする方針へ転換。
*   **実務運用シナリオの策定**:
    *   機能実装に先立ち「実務運用シナリオ (`OPERATIONAL_SCENARIOS.md`)」を策定するプロセスを導入。
*   **ダッシュボードの機能強化**:
    *   本日の予約パネルに「診察券番号検索」と「1分間隔の自動更新」を追加し、受付業務のリアルタイム性を向上。

#### 変更の背景 / 意思決定
*   現場（鍼灸・整体院等）では「まず予約を受け、担当は後で調整する」運用が一般的であり、システムによる強制が業務ブロッカーになると判断したため。
*   「正しいデータ」よりも「柔軟な運用」を優先し、アラート機能でミスを防ぐ設計を選択した。

### v1.1.0: 鍼灸・整体院向け最適化 & 予約高度化 (Phase 9 Update)
**日付**: 2025-12-10 〜 2025-12-11
**ステータス**: 実用性向上アップデート

#### 変更内容
*   **スタッフ役割の再定義**: 病院向けの `Doctor/Nurse` という呼称を廃止し、`Director` (院長) / `Therapist` (施術者) / `Clerk` (受付) に変更。
*   **予約・カルテ連携の強化**: 予約一覧から「カルテ作成」への直接遷移ボタンを実装。
*   **予約時間管理の変更 (重要)**:
    *   `Appointment` モデルで `duration` (所要時間) を利用開始（初期値60分）。
    *   予約作成・変更時に「所要時間」を選択できるようにし、重複チェックの精度を向上。
*   **安全性の向上**: タグ入力のデータ整合性検証、および `ConfigForm` のバリデーション強化。

#### 変更の背景 / 意思決定
*   ユーザーからの「個人経営の鍼灸院や整体院をターゲットにするため、役割名を無難なものに変更したい」という要望を反映。
*   「30分枠と60分枠が混在する現場」において、単純な開始時間の一致だけでは重複を防げないため、所要時間を明示的に扱う方針へ変更した。
*   「予約を確認してすぐカルテを書く」という現場のワークフローに即した導線改善を実施。

### v1.0.1: フェーズ境界プロトコルとBase Kit定義
**日付**: 2025-12-10
**ステータス**: 運用ルール確立 / Phase 8 仕切り直し

#### 変更内容
*   **運用ルールの厳格化**: `RESTRICTIONS.md` に「合意なき機能拡張の禁止」を追加。
*   **状態のロールバック**: 試験的に導入した画像アップロード機能を完全に Revert し、「汎用Base Kit」としてのクリーンな状態を確立。
*   **次フェーズのプロセス定義**: 機能追加（Phase 8）は必ず「機能選択の合意形成」を経てから行うプロセスを策定。

#### 変更の背景
*   AI主導で機能を作り込みすぎると、ユーザーの実際のオペレーションと乖離するリスクがあるため。
*   「何でもできる」状態よりも「必要なものだけがある」状態を維持する方針を明確にした。

---

### v1.0.0: プロトタイプ仕様固定と堅牢化 (Current)
**日付**: 2025-12-10
**ステータス**: 仕様書策定完了 / Phase 7 実装完了

#### 変更内容
*   **外部AIレビュー（Gemini 3.0 Pro / Claude 3.5 Sonnet）の統合と反映**。
*   Prismaスキーマの大幅な安全性強化:
    *   `ClinicalRecord` の `staffId` を必須化（責任所在の明確化）。
    *   `Patient` 削除時の制約を `Cascade` から `Restrict` に変更（誤削除防止）。
    *   `deletedAt` カラムの追加（論理削除の導入）。
    *   `Appointment` に `duration` を追加（重複検知の準備）。
    *   `Attachment` のパスを `storageKey` に変更（クラウド移行準備）。
*   **仕様書 (`SPEC_V1_DRAFT.md`) の確定**:
    *   バックアップ運用方針を「稼働中コピー禁止」に修正。
    *   認証機能の実装を「v1.0 必須要件」へ格上げ。

#### 変更の背景 / 意思決定
*   プロトタイプとして機能は揃ったが、外部AIレビューにより「医療記録システムとしてのデータ保全・監査性が不十分」との指摘を受けたため。
*   特に「SQLiteのバックアップ破損リスク」や「スタッフ不明のカルテ問題」は、リリース後の致命傷になり得るため、仕様策定フェーズで緊急対応した。

---

### v0.9.0: 仕様書ドラフト作成とフェーズ再定義
**日付**: 2025-12-10
**ステータス**: プロトタイプ実装一巡

#### 変更内容
*   開発フェーズ定義の更新:
    *   Phase 7 までを「プロトタイプ(MVP)」として区切り、ここで一旦仕様書を起こす方針へ変更。
    *   Phase 8 以降（画像機能など）を「拡張フェーズ」とし、仕様固定後に着手することにした。
*   `v1.0 仕様書ドラフト` の新規作成。
*   `Staff` 管理機能の初期実装（DBモデル追加、シードデータ投入）。
*   次回予約・カルテ連携の実装（UI上の統合）。

#### 変更の背景 / 意思決定
*   機能実装先行で進んできた結果、「見えない仕様（重複チェックロジックなど）」が増加し、ドキュメントなしでの拡張に限界を感じたため。
*   「CRUDアプリ」から「業務システム」への脱皮を図るため、まずは骨格（DBスキーマ）を固める必要があった。

---

### v0.5.0: 予約管理の独立とUI強化
**日付**: 2025-12-10 (Early)
**ステータス**: 基本機能実装中

#### 変更内容
*   **データモデル変更**:
    *   `ClinicalRecord` 内の日付管理から、独立した `Appointment` モデルへの分離。
    *   これにより「予約」と「実施記録」を別管理する一般的なCRM構造へ移行。
*   **UI/UX**:
    *   ダッシュボードに「本日の来院予定パネル」を追加。
    *   直近1時間のハイライトなど、現場での視認性を意識した改修。

#### 変更の背景 / 意思決定
*   初期構想ではカルテ＝予約日時だったが、「予約変更」や「キャンセル」の履歴管理、および「予約枠としての管理」を行うにはモデル分離が不可欠と判断したため。

---

### v0.1.0: プロジェクト初期化
**日付**: 2025-12-09
**ステータス**: 初期セットアップ

#### 変更内容
*   Next.js + Prisma + SQLite による基盤構築。
*   `Patient` (患者) と `ClinicalRecord` (カルテ) の基本CRUD実装。
*   AIテキスト取込機能（Beta）のPoC実装。

#### 変更の背景 / 意思決定
*   「一人院長のための第2の脳」というコンセプトに基づき、まずは手入力の負担を減らすAI連携をコア価値として検証するため。
