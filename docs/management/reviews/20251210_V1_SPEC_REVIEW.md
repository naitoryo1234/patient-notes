# 📋 Specification Review Report (v1.0 Draft)

**Status**: Completed
**Date**: 2025-12-10
**Target**: `docs/specs/SPEC_V1_DRAFT.md` (Initial Scheme)
**Reviewers**:
1.  **Gemini 3.0 Pro** (Google)
2.  **Claude 3.5 Sonnet / 4.5** (Anthropic)

---

## 📌 概要 (Summary)

v1.0 仕様書のドラフトに対し、2つの高度AIモデルによるクロスレビューを実施。
主に「医療データ特有の安全性（Data Integrity）」と「システムとしての堅牢性」の観点から多数の指摘を受け、それらを統合して仕様を確定させた。

本ドキュメントは、その際の**議論のプロセス、指摘事項、および意思決定の理由（Decision Log）**を記録するものである。

---

## 🔍 主な指摘事項と対応 (Key Feedback & Actions)

### 1. データ保全と安全性 (Data Integrity)
**指摘**:
医療現場での使用において、誤操作によるデータ消失は致命的である。物理削除（DELETE）はリスクが高すぎる。
また、スタッフの離職や異動があっても、過去のカルテにおける「誰が書いたか」という情報は永続的に保持される必要がある。

**対応**:
*   **論理削除の導入**: `Patient` モデルに `deletedAt` カラムを追加し、アプリ上での削除操作はフラグ更新のみとした。
*   **削除制約の厳格化**: Prisma の `onDelete` 制約を `Cascade`（連鎖削除）から `Restrict`（削除禁止）に変更。カルテが残っている患者は削除できないように制限を強化。
*   **Staff連携の永続化**: `ClinicalRecord` の `staffId` を必須化。スタッフが削除されてもカルテ側の記録が壊れないよう設計。

### 2. 責任所在の明確化 (Accountability)
**指摘**:
「いつ、誰が」記録したかが不明瞭なシステムは、医療・施術記録として信頼性が低い。

**対応**:
*   **Staffモデルの実装**: 簡易的な文字列ではなく、DBリレーションとして `Staff` を管理。
*   **必須フィールド化**: カルテ作成時に必ず担当者を選択させる仕様に変更（v1.0必須要件）。
*   **簡易監査ログ**: `revision` (版数) と `updatedBy` (更新者) フィールドを追加し、最低限の変更履歴を追えるように修正。

### 3. ファイル/画像管理 (Asset Management)
**指摘**:
ローカルパス（絶対パス）での保存は、将来の環境移行（クラウド化、複数PC運用）の際に大きな技術的負債となる。

**対応**:
*   **Storage Key概念の導入**: `filePath` (例: `C:\...`) ではなく、相対的な `storageKey` (例: `2024/12/uuid.jpg`) としてDBに保存する方針を採用。これにより、保存先がローカルDISKでもAWS S3でも、コードの書き換えを最小限に抑えられる。

### 4. セキュリティと認証 (Security)
**指摘**:
個人情報を扱う以上、認証なし（No Auth）の状態でのリリースはリスク許容限度を超えている。

**対応**:
*   v1.0 の必須要件として **NextAuth (Auth.js)** の導入を決定。
*   まずは「ログインしないとカルテが見られない」という基本的なアクセス制御を Phase 9 で実装する方針で合意。

---

## ⚖️ 見送った案 / 保留事項 (Trade-offs)

### A. 完全な監査ログ（Audit Trail）のテーブル化
**提案**: すべての操作（閲覧含む）をログテーブルに記録すべき。
**判断**: **見送り (Deferred)**。
**理由**: 個人院・小規模ユースケースの「Generic Base Kit」としては実装コストとDB容量への負荷が大きすぎるため。まずは `updatedBy` 等の簡易記録に留め、必要になった段階で拡張する（YAGNI原則）。

### B. 初期段階からのクラウドストレージ (S3) 強制
**提案**: 画像は最初からS3に置くべき。
**判断**: **見送り (Deferred)**。
**理由**: セットアップのハードルを上げすぎないため。「ローカルで `npm install` すればすぐ動く」という手軽さを維持しつつ、内部構造（Storage Key）だけクラウド対応準備をしておく折衷案を採用。

---

## 📝 結論 (Conclusion)

外部AIレビューを経たことで、当初の「入力が楽なメモ帳」というコンセプトから、「最低限の医療安全性を備えたミニCRM」へと仕様が成熟した。
特に **"Data Safety First"（データ安全第一）** の思想がスキーマレベルで組み込まれた点は大きな成果である。

以降の実装（Phase 8〜）は、この堅牢化された土台の上で、慎重に進めるものとする。
