# v1.1 Review Kit & Guidelines (Practice Ready Verification)

前回の v1.0 レビューで確定した方針（データ保全・責任所在）は**「既定事項」**として扱い、今回は**「新機能（予約管理）」の品質**と、**「前回の決定が正しく実装されているか（不整合がないか）」**の検証に集中します。

重複した議論を避け、実務運用（Practice Ready）の許可を得るためのレビューキットです。

---

## 1. モデル別 役割と依頼内容

| モデル | 担当領域 | 狙い |
| :--- | :--- | :--- |
| **Claude 3.5 Sonnet** | **UX & New Features** | 新機能「予約管理」のみに集中し、電話対応などの実務フローで詰まる箇所がないか確認する。 |
| **Gemini / GPT-4o** | **Integrity & Logic** | 「論理削除」と「ユニーク制約」の競合など、実装によって生じた新たな矛盾（バグ）を検出する。 |

---

## 2. レビュー依頼プロンプト (Copy & Paste)

以下のプロンプトを、指定されたファイルの中身と一緒に各AIへ投稿してください。

### 🅰️ パターンA: 整合性・バグ検証 (for Gemini / GPT-4o)
**目的**: 前回の決定事項（論理削除など）が、新たなバグを生んでいないかチェックする。

```markdown
あなたはDB信頼性エンジニアです。
現在開発中の「Clinic CRM Lite (v1.1)」について、前回のレビュー決定事項（論理削除導入・StaffId必須化）が、
実装段階で**新たな矛盾やバグ**を生んでいないか、厳しく検証してください。

## 前提（前回決定済み・変更不可）
1. データ保全のため、物理削除ではなく `deletedAt` による論理削除を採用した。
2. 責任所在明確化のため、`ClinicalRecord` には `staffId` を必須とした。

## レビュー対象ファイル
1. [prisma/schema.prisma の全内容]
2. [SPEC_V1_1.md の "2. データモデル" セクション]

## 重点的にチェックしてほしい点 (Killer Questions)
1. **論理削除とユニーク制約の競合**:
   - `Patient.pId` (診察券番号) は `@unique` ですが、論理削除済み(deletedAt!=null)の患者と同じ番号で新規登録しようとした場合、SQLite/Prismaの仕様的にエラーになりませんか？
   - エラーになる場合、どのような回避策（複合ユニーク制約など）が適切ですか？

2. **リレーションの不整合**:
   - 患者を論理削除した際、その患者の「未来の予約(Appointment)」や「未完のカルテ」はどう扱うべきですか？（アプリ側で手動キャンセルが必要？放置でよい？）

3. **Staff必須化の副作用**:
   - `Appointment` の担当者(`staffId`)は Nullable ですが、運用的にはこれで正しいですか？（「担当未定の予約」は発生しうるため）
```

---

### 🅱️ パターンB: 予約管理 UXレビュー (for Claude)
**目的**: 今回追加された「予約機能」の使い勝手のみをレビューする。

```markdown
あなたはクリニックの受付業務ワークフローに精通したUXデザイナーです。
v1.1で新たに追加された**「予約管理機能 (Appointment System)」**についてのみ、集中的にレビューしてください。
基盤部分（データ構造など）の議論は不要です。現場での「使い勝手」を見てください。

## レビュー対象ファイル
1. [SPEC_V1_1.md の "3.1 予約管理" および "Appointment" データモデル]
2. [PHASE_9_TASKS.md の予約関連タスク]

## 検証シナリオ
「電話がかかってきて、話しながら空き枠を探し、予約を入れて、電話を切る」

## 指摘してほしい点
1. **必須項目の壁**: 急いで予約を取る際、入力必須項目が多すぎてフローが止まる恐れはありませんか？
2. **キャンセルの見せ方**: キャンセルされた予約は、リスト上でどのように表示されるのが「邪魔にならず、かつ履歴として確認できる」ベストなUXですか？現在はアイコン化されています。
3. **未アサイン予約**: 「担当者未定」のまま予約を受けた際、当日の朝にそれが埋もれてしまわないためのUI的工夫は十分ですか？
```

---

## 3. レビュー後のアクションプラン

指摘事項は以下の基準で採用判断を行ってください。

1.  **即修正 (MUST)**:
    *   アプリがクラッシュする、またはデータ登録不可になる論理矛盾（例: ユニーク制約エラー）。
2.  **運用回避 / 注記 (SHOULD)**:
    *   修正コストが高いが、発生頻度が低いもの。
    *   `SPEC_V1_1.md` に「既知の制限事項」として運用ルール（例: 削除済みIDは再利用しない）を追記して対応する。
3.  **却下・次期 (WON'T / DEFER)**:
    *   v1.0/1.1 のスコープを超える機能追加提案。
