# 🏥 実務運用シナリオ集 (Operational Scenarios)

このドキュメントは、システム実装の前に「現場の実務で発生しうる様々なパターン」を洗い出し、最適なUI/UXを設計するためのリファレンスです。
機能実装を行う際は、まずこのシナリオを確認し、仕様が実務に即しているかを検証してください。

---

## 📅 1. 予約管理 (Appointment Management)

### 1-1. 担当者未定での予約確保 (Tentative Booking)

**状況**  
- 受付で電話を受けた際、患者の希望日時だけが決まっている。  
- 指名なしで「空いている人で」と言われたが、どのスタッフを割り当てるかは後で決めたいケース。

**運用の正解**  
- まずは「枠を押さえる」ことを優先し、担当未定のまま予約を確定できる。  
- 担当割り当ては、シフト確定後や当日朝の段階で調整する。

**システム挙動**  
- Staff 選択は必須ではなく、`未定（Unassigned）` を選べる。  
- `Unassigned` のまま予約を保存できる。  
- 一覧・ダッシュボードでは `未定` の予約を視覚的に強調（アイコン・色など）し、割り当て漏れを防ぐ。

**UI要件**  
- 予約フォーム：Staff プルダウンに `未定` を含める（デフォルトで選択可能）。  
- ダッシュボード：  
  - 「本日の未割り当て予約」を警告表示する。  
  - 未定の予約はカード背景色（赤など）で一目で分かるようにする。  
- 編集画面：一度担当者を設定した予約でも `未定` に戻せる（担当解除可能）。

**Priority / Version**  
- Priority: **P0**（毎日の受付で頻発するため必須）  
- Version: **v1.1.0** (Implemented) / **v1.2** (Refine)

**Implementation Checklist**  
- [x] Staff を未選択（Unassigned）で保存できる  
- [x] ダッシュボードで Unassigned の予約を強調表示する（赤色背景）  
- [ ] 「未割り当て予約」だけを絞り込むフィルタ機能  
- [x] 編集画面から担当者を `未定` に戻せる

**Test Points**  
- 担当者を指定せずに予約を作成し、エラーにならず保存できるか。
- ダッシュボード上で、担当者ありの予約と明確に区別（赤色表示など）されているか。
- 編集モーダルで既存の担当者を「未定」に変更して保存できるか。

---

### 1-2. 担当者の変更 (Reassignment)

**状況**  
- 担当スタッフが急病で休んだり、別の急患対応で手が離せなくなった場合。  
- 当日のオペレーション変更で、急遽担当を入れ替える必要が出た場合。

**運用の正解**  
- 既存の予約を削除することなく、「担当者」フィールドだけをスムーズに変更できる。  
- 変更先の担当者が空いているかどうかのチェックが行われる。

**システム挙動**  
- 予約編集画面から担当者を変更する。  
- 変更後の時間帯で担当者が既に埋まっている場合は、重複エラー（Conflict）を表示してユーザーに通知する。

**UI要件**  
- 予約詳細/編集モーダルで、担当者プルダウンを変更して「更新」するだけのシンプル操作。  
- スタッフ割り当て状況が視覚的にわかりやすいことが望ましい（P2）。

**Priority / Version**  
- Priority: **P0**（日常的な運用で必須）  
- Version: **v1.1.0** (Implemented)

**Implementation Checklist**  
- [x] 既存予約の担当者を変更できる  
- [x] 変更時に、変更先スタッフのスケジュール重複をチェックする  
- [ ] 重複時に「強制割り当て」するオプション（P2機能）

**Test Points**  
- 予約編集画面でスタッフAからスタッフBに変更し、保存できるか。
- スタッフBがその時間に既に予約を持っている場合、適切にエラーが表示され保存がブロックされるか。

---

### 1-4. 同日複数回利用 (Multiple Visits in a Day)

**状況**  
- 午前中に診察を受け、一度帰宅後、夕方にリハビリ等で再来院する場合。  
- 同じ患者IDで、同一日に2つの予約枠を確保する必要がある。

**運用の正解**  
- 時間帯（Start Time + Duration）が完全に重なっていなければ、同日でも予約可能とする。  
- 来院回数カウントは、予約単位（Visit単位）でインクリメントする。

**システム挙動**  
- 同一患者・同一日時の重複はブロックする。  
- 同一患者・別時間の予約は許可する。  
- 来院回数表示は、その日の2回目の来院であれば「n+1回目」と表示される。

**UI要件**  
- 予約作成時に警告を出さない（時間が被っていない限り）。  
- ダッシュボードやリストで、同じ患者が2行表示されても違和感のないデザイン。

**Priority / Version**  
- Priority: **P1**（リハビリ併設クリニック等で重要）  
- Version: **v1.2**

**Implementation Checklist**  
- [x] 同じ患者でも時間がずれていれば同日予約を保存できる  
- [x] 来院回数（Visit Count）が予約ごとに正しく計算・表示される  
- [ ] 患者詳細画面で、同日の履歴が分かりやすく表示される

**Test Points**  
- 患者Aの10:00の予約がある状態で、同日16:00の予約を作成・保存できるか。
- 10:00の予約作成時は「10回目」、16:00の予約作成時は「11回目」のようにカウントが進んでいるか。

---

### 1-5. 遅刻・時間延長への対応 (Late Arrival & Extension)

**状況**  
- 患者が遅刻し、開始時間を遅らせる必要がある。あるいは施術内容変更で延長が必要になった。  
- 変更により、後ろの予約枠に食い込む可能性がある。

**運用の正解**  
- 編集画面から即座に「開始時間」や「所要時間（Duration）」を修正できる。  
- 修正の結果、他の予約と重複する場合は警告を出す。

**システム挙動**  
- 予約編集画面で `Start Time` や `Duration` を変更可能にする。  
- 保存時に重複チェック（Staff & Patient）を再実行する。

**UI要件**  
- 時間変更はプルダウンまたは数値入力でスムーズに行える。  
- ドラッグ＆ドロップでの時間変更（カレンダービュー等）は将来検討（P2）。

**Priority / Version**  
- Priority: **P1**（柔軟な運用のために重要）  
- Version: **v1.1.0** (Basic Edit) / **v1.2** (UX改善)

**Implementation Checklist**  
- [x] 予約編集画面で開始時間を変更できる  
- [x] 予約編集画面で所要時間（Duration）を変更できる  
- [x] 変更により重複が発生した場合、保存をブロックしエラー表示する  
- [ ] ドラッグ＆ドロップによる時間変更（P2）

**Test Points**  
- 予約の所要時間を60分から90分に変更し、正しく保存されるか。
- 時間をずらした結果、担当者の次の予約と重なる場合にエラーで弾かれるか。

---

### 1-6. ダブルブッキングの許容 (Overbooking / Force Booking)

**状況**  
- 担当者のスケジュールは埋まっているが、急患などで「無理やり」予約を入れたい場合。  
- システムの重複チェックを特定の権限でバイパスしたい。

**運用の正解**  
- 通常は重複NGだが、「強制割り当て（Force Create）」オプションがあれば重複状態でも登録できる。  
- ただし v1.x では安全側に倒し、原則ブロック（許容しない）とする。

**システム挙動**  
- 基本設定：重複はエラー。  
- 将来拡張：管理者権限などで「重複を無視して登録」チェックボックスを表示。

**UI要件**  
- 重複エラー時に「強制的に登録する」ボタンを表示（将来）。

**Priority / Version**  
- Priority: **P2**（v1.2では非対応でOK）  
- Version: **Future (v2.x)**

**Implementation Checklist**  
- [x] 通常の重複はブロックされる（現状）  
- [ ] エラー画面に「強制登録」オプションを追加する（未実装）

**Test Points**  
- 現状、重複する時間に予約を入れようとしたら確実にエラーになり、データ整合性が守られるか。

---

## 🏥 2. 受付・来院管理 (Reception Workflow)

### 2-1. 来院チェックイン (Check-in)

**状況**  
- 予約していた患者がクリニックに到着した。  
- 受付スタッフは「誰が来ているか」を把握し、ステータスを更新する必要がある。

**運用の正解**  
- ワンクリック・ワンアクションで「到着」を記録できる。  
- ダッシュボードを見ると、待合室にいる患者（到着済みだが未完了）が一目で分かる。

**システム挙動**  
- 予約ステータスを `arrived` に更新する。  
- `arrivedAt` に現在時刻を記録する。

**UI要件**  
- ダッシュボードの「本日の予定」カード上に「受付（Check-in）」ボタンを配置。  
- チェックイン後は、カードの色（Indigo等）やバッジ（来院済み）で状態を可視化する。

**Priority / Version**  
- Priority: **P0**（受付業務の基本）  
- Version: **v1.1.2** (Implemented)

**Implementation Checklist**  
- [x] Appointment モデルに `arrivedAt` を追加  
- [x] ダッシュボードに Check-in ボタンを配置  
- [x] ステータス変更後、カードのデザインが変わる（視認性向上）  
- [ ] 「来院中」リストだけの別タブ表示（P2）

**Test Points**  
- ダッシュボードのボタンを押すと、DBのステータスが更新されるか。
- リロード後も「来院済み」の状態（色、バッジ）が維持されているか。

---

### 2-2. 会計・次回の予約 (Checkout & Re-booking)

**状況**  
- 診察・施術が終わり、患者が帰る際（会計時）に次回の予約を取る。  
- 「今の患者さんの、来週の予約」をスムーズに取りたい。

**運用の正解**  
- 患者を探し直すことなく、現在のコンテキスト（患者詳細）から予約作成画面へ遷移できる。  
- 患者IDや名前は自動入力されている。

**システム挙動**  
- 患者詳細ページの「予約作成」ボタンから、モーダルまたは予約作成ページを開く。  
- `patientId` が初期値としてセットされた状態にする。

**UI要件**  
- 患者詳細ページの分かりやすい位置（ヘッダーや予約リスト付近）に「＋予約作成」ボタンがある。

**Priority / Version**  
- Priority: **P1**（導線として重要）  
- Version: **v1.2**

**Implementation Checklist**  
- [x] 患者詳細画面に「予約追加」ボタンがある  
- [x] ボタンを押すと、その患者が選択された状態で予約フォームが開く  
- [ ] 会計機能の実装（Scope外 / P2）

**Test Points**  
- 患者詳細画面から「予約」ボタンを押し、患者名が入力済みの状態で予約作成ができるか。
