# Clinic Notebook (Lite CRM) v1.1 仕様書 (Practice Ready)

## 0. ドキュメント情報
- **Version**: 1.1.0 (Practice Ready)
- **Status**: Stable
- **Last Updated**: 2025-12-10
- **Authors**: Team HARU (AI Agent) & Doctor (User)

---

## 1. システム概要

### 1.1 コンセプト
一人院長や小規模クリニック向けの「第2の脳」としてのミニCRM。
事務処理ツールではなく、**患者との対話や信頼関係（ラポール）を深めるための「記憶補助ツール」**を目指す。
v1.1.0 "Practice Ready" では、予約管理の実用化により、日々の診療フロー（予約確認→施術→次回予約）を単独で完結可能にした。

### 1.2 コア・ユースケース (v1.1 Flow)
1.  **来院前チェック**: ダッシュボードで「本日の予約」を確認。未アサインや時間重複を一目で把握。
2.  **施術・対話**: 過去カルテや「前回いつ来たか」「ラポールメモ」を参照しながら会話。
3.  **記録 (SOAP)**:
    - AI取込機能により、書き殴ったメモや音声認識テキストを構造化データへ変換。
    - 生成後のプレビュー画面で誤字修正が可能。
    - 「前回コピー(Do)」機能でルーチン処方の入力時間を短縮。
4.  **次回予約**: 施術画面またはリストから即座に次回予約を登録。

---

## 2. データモデル (Prisma Schema v1.1)

### 2.1 ER概要
- **Patient**: 患者基本情報。論理削除(`deletedAt`)対応。
- **ClinicalRecord**: 施術記録。`staffId`必須により責任所在を明確化。
- **Appointment**: 独立した予約管理モデル。ステータス管理機能付き。
- **Staff**: 医師・スタッフマスタ。
- **Attachment**: (将来拡張) 画像等の添付ファイル。

### 2.2 主要テーブル定義

#### Patient (患者マスタ)
| Field | Type | Note |
|---|---|---|
| `id` | UUID | システム内部ID |
| `pId` | Int | **診察券番号** (ユニーク, 自動採番) |
| `name`, `kana` | String | 氏名, カナ (検索用) |
| `tags` | JSON | 特徴タグ (例: `["VIP", "腰痛"]`) |
| `tags` | JSON | 特徴タグ (例: `["VIP", "腰痛"]`) |
| `deletedAt` | DateTime? | **論理削除日時** (データ保全のため物理削除は禁止) |
| ※Note | - | **診察券番号(pId)は永久欠番運用**。論理削除後も番号は保持され、再利用されない。 |

#### Appointment (予約)
v1.1で大幅強化された予約管理の中核。
| Field | Type | Note |
|---|---|---|
| `startAt` | DateTime | 予約開始日時 |
| `duration` | Int | 所要時間 (分, default: 30) |
| `status` | String | `scheduled` (予定), `completed` (完了), `cancelled` (キャンセル) |
| `staffId` | UUID? | 担当スタッフ (Nullable: 未定/指名なし対応) |
| `memo` | String? | 受付メモ |

#### ClinicalRecord (施術記録)
| Field | Type | Note |
|---|---|---|
| `visitDate` | DateTime | 来院日 |
| `subjective`~`plan` | String | SOAP各フィールド |
| `staffId` | UUID | **必須** (記録者) |
| `rawText` | String? | AI解析前の元テキスト |

---

## 3. 画面・機能仕様

### 3.1 予約管理 (Appointment Management)
- **ダッシュボード/リスト表示**:
    - **ステータスアイコン**: ✅(完了), 📅(予定), ❌(キャンセル) で状態を視覚化。
    - **フィルタリング**: 「担当スタッフ」ごとの絞り込みが可能。「未アサイン」の検出も容易。
    - **当日ハイライト**: 当日の予約をリスト上位や強調色で表示。
    - **アラート表示**: 担当者未定（未アサイン）の予約がある場合、フィルタリング状態に関わらずリスト上部に警告を表示。
- **CRUD操作**:
    - 作成: 患者詳細またはクイックアクションから作成可能。
    - 編集: 日時変更、担当者変更、メモ追記。
    - キャンセル: ステータス変更による論理的なキャンセル扱い（履歴に残る）。
        - **表示**: キャンセル済みデータはグレーアウト＋取り消し線表示とし、視覚的なノイズを低減する。

### 3.2 患者検索・リスト (Patient List)
- **最終来院日表示**: リスト上で「直近の来院日」を表示し、休眠患者や頻回患者を一目で判別可能。
- **検索機能**: 名前、カナ、診察券番号でのインクリメンタルサーチ。

### 3.3 カルテ入力 (Clinical Record)
- **AI取込 (Smart Import)**:
    - 自由テキスト貼り付け → AIによるSOAP構造化。
    - **編集プレビュー**: AI解析結果をDB保存する前に、画面上で直接修正可能（誤字訂正など）。
    - **ガイド表示**: 効果的なプロンプト例を表示し、入力品質を安定化。
- **前回Do機能**: 直近のカルテ内容をワンクリックでコピー。
- **履歴削除**: 誤登録したカルテの削除機能（物理削除/Restrict制約あり）。

---

## 4. セキュリティ・運用ポリシー

### 4.1 データ保全
- **論理削除の徹底**: `Patient` テーブル等の誤削除を防ぐため、アプリ上では `deletedAt` を埋める論理削除のみを許可する（Phase 9以降）。
    - **整合性維持**:
        - 外部キー制約(`Restrict`)により、カルテが存在する患者の物理削除をDBレベルでブロック。
        - **自動キャンセル**: 患者を論理削除する際、その患者に関連する「未来の予約(status=scheduled)」を自動的にキャンセル扱いに更新するロジックを実装必須とする。

### 4.2 開発運用
- **Base Kit思想**: 特定のクリニックに特化しすぎず、汎用的な「素体」としてのシンプルさを保つ。
- **マイグレーション**: スキーマ変更時は必ず `prisma migrate` を使用し、整合性を保つ。

---

## 5. ロードマップ (Next Steps)

### v1.1.x (Phase 9 残タスク)
- **UX改善**:
    - [4-2] 新規登録時の重複警告から「既存患者へ移動」するアクション。
    - [1-2] 検索結果リストへの「タグ」バッジ表示。
- **設定機能**:
    - アプリ設定画面の検討 ( `docs/management/IDEAS.md` )。

### v1.2.0 (Phase 10: Launch Pad)
- **最終調整**: 本番運用に向けた細部のチューニング。
- **配布準備**: 簡易インストーラーやDocker構成の整理。
