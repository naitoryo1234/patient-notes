# Clinic Notebook (Lite CRM) v1.2 仕様書 (Demo Ready)

## 0. ドキュメント情報
- **Version**: 1.2.0 (Demo Ready)
- **Status**: Stable
- **Last Updated**: 2025-12-13
- **Authors**: Team HARU (AI Agent) & Doctor (User)
- **Demo URL**: https://patient-notes-demo.vercel.app (Vercel Postgres版)

---

## 1. システム概要

### 1.1 コンセプト
一人院長や小規模クリニック向けの「第2の脳」としてのミニCRM。
事務処理ツールではなく、**患者との対話や信頼関係（ラポール）を深めるための「記憶補助ツール」**を目指す。

v1.2.0 "Demo Ready" では、以下の強化によりデモ配布可能な品質に到達:
- **AI取込ガイドの統一**: シンプル版/詳細版のハイブリッドUIで初回ユーザーにも分かりやすく
- **かな検索の強化**: ひらがな/カタカナを区別しない統一検索
- **ラベル管理**: 文言の変数化により汎用性を向上
- **デモ環境**: Vercel + PostgreSQL での動作実証

### 1.2 コア・ユースケース (v1.2 Enhanced Flow)
1.  **来院前チェック**: ダッシュボードで「本日の予約」を確認。未アサインや時間重複を一目で把握。
    - *New*: スマートディレクトリ（履歴/検索/要確認タブ）で即座に状況把握
2.  **施術・対話**: 過去カルテや「前回いつ来たか」「ラポールメモ」を参照しながら会話。
3.  **記録 (SOAP)**:
    - AI取込機能により、書き殴ったメモや音声認識テキストを構造化データへ変換。
    - *New*: ハイブリッドAI取込ガイドで効率的な入力を支援。
    - 「前回コピー(Do)」機能でルーチン処方の入力時間を短縮。
4.  **次回予約**: 施術画面またはリストから即座に次回予約を登録。

---

## 2. データモデル (Prisma Schema v1.2)

### 2.1 ER概要
- **Patient**: 患者基本情報。論理削除(`deletedAt`)対応。
- **ClinicalRecord**: 施術記録。`staffId`必須により責任所在を明確化。
- **Appointment**: 独立した予約管理モデル。ステータス管理 + 申し送りメモ機能付き。
- **Staff**: 医師・スタッフマスタ。有効/無効ステータス管理。
- **Attachment**: (将来拡張) 画像等の添付ファイル。

### 2.2 主要テーブル定義

#### Patient (患者マスタ)
| Field | Type | Note |
|---|---|---|
| `id` | UUID | システム内部ID |
| `pId` | Int | **診察券番号** (ユニーク, 自動採番) |
| `name`, `kana` | String | 氏名, カナ (検索用) |
| `tags` | JSON | 特徴タグ (例: `["VIP", "腰痛"]`) |
| `deletedAt` | DateTime? | **論理削除日時** (データ保全のため物理削除は禁止) |
| ※Note | - | **診察券番号(pId)は永久欠番運用**。論理削除後も番号は保持され、再利用されない。 |

#### Appointment (予約)
| Field | Type | Note |
|---|---|---|
| `startAt` | DateTime | 予約開始日時 |
| `duration` | Int | 所要時間 (分, default: 30) |
| `status` | String | `scheduled` / `completed` / `cancelled` |
| `staffId` | UUID? | 担当スタッフ (Nullable: 未定/指名なし対応) |
| `memo` | String? | 受付メモ |
| `adminMemo` | String? | *New* 申し送りメモ（スタッフ間連絡用） |
| `adminMemoResolvedAt` | DateTime? | *New* 申し送り解決日時 |

#### ClinicalRecord (施術記録)
| Field | Type | Note |
|---|---|---|
| `visitDate` | DateTime | 来院日 |
| `subjective`~`plan` | String | SOAP各フィールド |
| `staffId` | UUID | **必須** (記録者) |
| `rawText` | String? | AI解析前の元テキスト |

---

## 3. 画面・機能仕様

### 3.1 ダッシュボード (v1.2 Enhanced)
- **本日の来院予定パネル**:
    - 自動更新 (1分ごとのポーリング)
    - 来院チェックイン（楽観的UI更新）
    - *New*: チェックインUndo機能
    - 未アサイン/申し送りありの視覚的強調
- **スマートディレクトリ (右カラム)**:
    - *New*: 3タブ構成（履歴 / 検索結果 / 要確認）
    - 要確認タブで未アサイン予約・未解決申し送りを一覧表示

### 3.2 予約管理 (Appointment Management)
- **リスト表示**:
    - ステータスアイコン: ✅(完了), 📅(予定), ❌(キャンセル)
    - *New*: コンパクトアラートバッジ（ツールバー統合）
    - *New*: ページネーションの上部配置
    - フィルタリング: 担当スタッフ、ステータス別
- **CRUD操作**:
    - 作成: 患者詳細またはクイックアクションから
    - 編集: 日時変更、担当者変更、メモ追記
    - キャンセル: 論理キャンセル（履歴に残る）
- **重複チェック (v1.1~)**:
    - 同一患者/同一スタッフの時間重複をサーバーサイドで検出・ブロック

### 3.3 患者検索・リスト (Patient Search)
- **統一検索 (v1.2 Enhanced)**:
    - *New*: ひらがな/カタカナを区別しない統一検索（`kanaUtils.ts`）
    - 名前、カナ、診察券番号でのインクリメンタルサーチ
    - ダッシュボード、予約モーダル、重複チェックすべてに適用
- **最終来院日表示**: 休眠患者や頻回患者を一目で判別可能

### 3.4 カルテ入力 (Clinical Record)
- **AI取込 (Smart Import v1.2)**:
    - *New*: ハイブリッドガイドUI（シンプル版/詳細版）
    - *New*: かんたん3ステップ説明
    - *New*: プロンプトコピーボタン
    - 編集プレビュー: AI解析結果をDB保存前に修正可能
- **前回Do機能**: 直近のカルテ内容をワンクリックでコピー
- **履歴削除**: 誤登録したカルテの削除機能
- **削除確認**: *New* ConfirmDialogによるモダンな確認UI

### 3.5 設定・管理機能 (v1.2 New)
- **スタッフ管理** (`/settings/staff`):
    - スタッフ追加/無効化
    - 無効化スタッフは予約・カルテのドロップダウンから除外
- **バックアップ機能** (`/settings`):
    - *New*: SQLiteファイルのダウンロード機能
- **ラベル管理** (`src/config/labels.ts`):
    - *New*: UIテキストの変数化（将来の多言語/業種別対応の基盤）

---

## 4. 技術スタック

### 4.1 フロントエンド
- **Framework**: Next.js 14 (App Router)
- **Styling**: Tailwind CSS + shadcn/ui
- **State**: React Server Components + Client Components

### 4.2 バックエンド
- **API**: Server Actions (Next.js built-in)
- **Validation**: Zod
- **ORM**: Prisma

### 4.3 データベース
- **開発環境**: SQLite (`dev.db`)
- **デモ環境**: PostgreSQL (Vercel Postgres / Neon)
- **ブランチ戦略**:
    - `main`: SQLite版（ローカル開発）
    - `deploy/vercel-demo`: PostgreSQL版（Vercel Postgres）

---

## 5. セキュリティ・運用ポリシー

### 5.1 データ保全
- **論理削除の徹底**: `Patient` テーブルは `deletedAt` を埋める論理削除のみ
- **整合性維持**:
    - 外部キー制約(`Restrict`)でカルテ存在患者の物理削除をブロック
    - 患者削除時、未来の予約を自動キャンセル
- **バックアップ**: 設定画面からSQLiteファイルをダウンロード可能

### 5.2 開発運用
- **Base Kit思想**: 特定のクリニックに特化しすぎず、汎用的な「素体」を保つ
- **マイグレーション**: スキーマ変更時は `prisma migrate` を使用

---

## 6. v1.1 → v1.2 変更点サマリー

| カテゴリ | 変更内容 |
|----------|----------|
| **AI取込** | ハイブリッドガイドUI、シンプル版/詳細版、かんたん3ステップ |
| **検索** | ひらがな/カタカナ統一検索（`kanaUtils.ts`） |
| **ダッシュボード** | スマートディレクトリ（3タブ）、チェックインUndo |
| **予約リスト** | コンパクトアラート、ページネーション上部配置 |
| **UI/UX** | ConfirmDialog全面導入（`window.confirm`廃止） |
| **設定** | バックアップ機能、スタッフ管理強化 |
| **ラベル** | 文言の変数化（`labels.ts`） |
| **デモ** | Vercel + PostgreSQL 対応 |

---

## 7. ロードマップ (Next Steps)

> 詳細は [docs/ROADMAP.md](../ROADMAP.md) を参照

### v1.2.x (安定化)
- ラベル管理の残りコンポーネントへの適用
- モバイル最適化の追加対応

### v1.3.0 (汎用化)
- **業種別プリセット**: 医療系(SOAP) / サロン系 / シンプル(メモ)
- **カスタム機能フレームワーク**: 機能のON/OFF切替基盤

### v2.0.0 (将来)
- 予約カレンダービュー（カスタム機能として）
- 繰り返し予約機能
- LINE連携、AI音声整形（有料機能候補）

---

## 8. 既知の制限事項

| 項目 | 内容 | 対応予定 |
|------|------|----------|
| カレンダービュー | リスト表示のみ | v2.0でカスタム機能として検討 |
| 繰り返し予約 | 未対応 | v2.0で検討 |
| 多言語対応 | 日本語のみ | ラベル管理基盤は準備済み |
| オフライン対応 | 未対応 | 将来検討 |
