# Clinic Notebook (Lite CRM) v1.0 仕様書 (Draft)

## 1. システム概要

### 1.1 コンセプト
一人院長や小規模クリニック向けの「第2の脳」としてのミニCRM。
レセコンのような事務処理ツールではなく、**患者との対話や信頼関係（ラポール）を深めるための「記憶補助ツール」**を目指す。
複雑な設定を排除し、直感的な操作で「記録 → 参照 → 予約」のサイクルを回せることを最優先する。

### 1.2 想定ユーザー
- **メインユーザー**: 院長（医師・施術者）。診療中に手元で操作。
- **サブユーザー**: 受付スタッフ。電話予約や会計時の次回予約登録に使用。

### 1.3 コア・ユースケース (MVPフロー)
1.  **来院前チェック**: ダッシュボードの「本日の来院予定」を見て、患者の主訴や前回のメモを確認。
2.  **施術・対話**: 過去のカルテや「ラポールメモ（趣味・家族など）」を参照しながら会話。
3.  **記録 (SOAP)**: 施術直後にテンプレートやAI取込を用いて素早く記録。
4.  **次回予約**: その場で次回予約を取り、システムに登録。

---

## 2. データモデル / Prisma スキーマ設計

### 2.1 ER図 (概要)
`Patient` (1) -- (*) `ClinicalRecord`
`Patient` (1) -- (*) `Appointment`
`Patient` (1) -- (*) `Attachment`
`Staff` (1) -- (*) `ClinicalRecord`
`Staff` (1) -- (*) `Appointment`

### 2.2 テーブル定義

#### Patient (患者マスタ)
- **ID設計**: UUID。
- **pId (診察券番号)**: `Int @unique` (アプリ採番)。v1.0ではシングルテナント前提とし、将来のSaaS化時は `[tenantId, pId]` 複合キーへの移行を想定（マイグレーション対応）。
- **Tags (タグ)**: JSON文字列として保存。
- **論理削除**: `deletedAt` カラムを持ち、医療データの誤消失を防ぐ。

#### ClinicalRecord (施術記録)
- **責任所在**: `staffId` を必須(Required)項目とし、誰が記録したかを明確化。
- **簡易監査**: `revision` (版数) と `updatedBy` (最終更新者) フィールドを追加し、変更履歴の基礎を作る。
- **データ保護**: 患者削除時は `Restrict` 制約により、カルテが存在する状態での患者削除をブロックする。

#### Appointment (予約)
- **日時管理**: `startAt` (開始) + `duration` (分/30分初期値) で管理。
- **ステータス**: `scheduled`, `completed`, `cancelled`。

#### Attachment (将来実装)
- **パス管理**: `filePath` ではなく `storageKey` (相対パス) で管理し、S3等への移行を容易にする（例: `2024/01/<uuid>.jpg`）。

### 2.3 データ保全観点
- **論理削除の徹底**: Patient テーブルへの `deletedAt`導入。
- **Staff連携**: スタッフ削除時もカルテの `staffId` は保持される（Staffテーブル側も論理削除運用とするため）。

---

## 3. 画面・機能フロー

### 3.1 ダッシュボード (`/`)
- **本日の来院予定**: 当日の予約リストを表示。
- **ステータスハイライト**: 直近1時間以内の予約を強調表示（黄色）、来院時刻（緑色）など。
- **担当者表示**: 誰が担当するかを表示。

### 3.2 患者詳細画面 (`/patients/[id]`)
- **2カラムレイアウト**: 左側にプロフィール・予約・新規カルテ入力。右側にタイムライン（過去カルテ）。
- **次回予約**: 予約が存在する場合、プロフィール直下にカード表示。
- **カルテ入力**: 埋め込みフォーム。過去ログ参照型。
- **AI取込 (Beta)**: テキスト貼り付け -> 自動パース。

### 3.3 新規患者登録
- 重複チェック機能搭載。

---

## 4. セキュリティ & 認証戦略 (Updated)

### 4.1 認証 (v1.0 必須要件)
- NextAuth (Auth.js) による認証必須化。
- ロールベース制御 (RBAC) の準備。

### 4.2 入力バリデーション
- Server Action + Zod 必須。

---

## 5. バックアップ / 運用 (v1.0)

### 5.1 SQLiteバックアップ (Updated)
- **重要**: 稼働中の単なるファイルコピーはDB破損リスクがあるため禁止。
- **推奨手順**:
    - アプリ停止下のコピー、または
    - SQLite `.backup` コマンドを使用するスクリプト化、または
    - LiteFS 等のレプリケーションツール導入（クラウド運用時）。

### 5.2 データ所有権
- エクスポート機能（CSV/JSON）により担保。

---

## 5. 監査証跡 (Audit Trail) 設計案

医療データとしての信頼性を担保するため、以下の実装をPhase 8以降で検討。

### 5.1 AuditLog テーブル案
| Field | Type | Description |
|---|---|---|
| `id` | UUID | |
| `targetTable` | String | 操作対象テーブル (Patient, ClinicalRecord) |
| `targetId` | String | 対象レコードID |
| `operation` | String | CREATE, UPDATE, DELETE, VIEW(主要な参照のみ) |
| `diff` | JSON | 変更前後の差分 `{ "old": ..., "new": ... }` |
| `performedBy` | String | 操作スタッフID |
| `performedAt` | DateTime | 操作日時 |
| `ipAddress` | String | 接続元IP (Option) |

---

## 6. セキュリティ・個人情報保護

### 6.1 認証 (Authentication)
- v1.0 (MVP) では、「院内LANからのアクセスのみ」または「Basic認証」等の簡易制限からスタートする場合があるが、基本的には **ログイン機能 (Auth.js等)** の実装を必須とする。
- 少なくとも「誰が書いたか」を特定するためにログインセッションは必要。

### 6.2 インフラ・通信
- **HTTPS必須**: ローカルネットワーク内であっても可能な限りHTTPS通信を推奨。
- **DB暗号化**: クラウドDB利用時はAt-Rest Encryption（保存時暗号化）が有効なサービスを選定。

### 6.3 入力検証
- **Zod Schema**: すべてのServer Actionで `Zod` による厳格なバリデーションを行う。
- **XSS対策**: Reactの標準エスケープに頼りつつ、`dangerouslySetInnerHTML` は原則禁止。

---

## 7. デプロイと運用

### 7.1 推奨構成
- **Pattern A (クラウド)**: Vercel (App) + Neon/Supabase (DB)。バックアップやセキュリティをプラットフォームに委任できる推奨構成。
- **Pattern B (ローカル)**: 院内PCにて Docker コンテナまたは Node.js 直接実行。データが手元にある安心感はあるが、ハードウェア故障リスクの対策が必須。

### 7.2 バージョン管理
- GitHub flow を採用。`main` ブランチを常にデプロイ可能な状態に保つ。
- 機能追加は `feature/xxx` ブランチで行い、PRにてマージ。

---

## Review Points (for External AI)
以下の点について重点的にレビューをお願いします。

1.  **DBスキーマの柔軟性**: 将来的に「複数院対応（tenantId追加）」や「保険診療項目の追加」を行う際、現在の構造が足枷にならないか。
2.  **監査ログの粒度**: 個人院レベルのシステムとして、どこまでのログ取得が現実的かつ必要十分か。
3.  **添付ファイルの扱い**: 将来実装のAttachmentテーブルについて、外部ストレージ（S3等）とローカルファイルシステムのどちらを主軸に置くべきか、スキーマ上の考慮点。
