# 🧪 動作確認手順書: カルテ/記録 (Clinical Record)

## 📌 概要
本ドキュメントは、カルテ（施術記録）機能の動作確認手順と期待される挙動を定義します。

---

## 1. 記録作成 (Create)

| ID | 項目 | 手順 / 条件 | 期待される挙動 |
|:---|:---|:---|:---|
| RC-01 | **作成画面遷移** | 患者詳細ページの「記録追加」ボタンをクリックする。 | ・記録作成フォームが表示される。<br>・患者情報がプリフィルされている。 |
| RC-02 | **SOAP入力** | 主訴(S)、所見(O)、施術(A)、計画(P)を入力する。 | ・各フィールドに入力可能。<br>・改行・長文が許可される。 |
| RC-03 | **担当者選択** | 担当者（記録者）を選択する。 | ・ドロップダウンからスタッフを選択できる。<br>・（認証有効時）ログインユーザーがデフォルト選択される。 |
| RC-04 | **保存確認** | 全項目を入力して保存ボタンをクリックする。 | ・保存成功メッセージが表示される。<br>・患者詳細ページの記録一覧に表示される。 |
| RC-05 | **来院回数自動付与** | 同一患者の2件目の記録を作成する。 | ・来院回数（visitCount）が自動的に設定される。 |

---

## 2. 記録編集 (Update)

| ID | 項目 | 手順 / 条件 | 期待される挙動 |
|:---|:---|:---|:---|
| RC-06 | **編集画面遷移** | 記録一覧から既存記録の「編集」ボタンをクリックする。 | ・編集フォームが表示される。<br>・既存データがプリフィルされている。 |
| RC-07 | **内容更新** | 主訴を変更して保存する。 | ・更新成功メッセージが表示される。<br>・変更内容が反映されている。 |
| RC-08 | **リビジョン管理** | 記録を編集して保存後、リビジョン番号を確認する。 | ・`revision` が1増加している。<br>・`updatedBy` に編集者IDが記録される。 |

---

## 3. 記録一覧表示

| ID | 項目 | 手順 / 条件 | 期待される挙動 |
|:---|:---|:---|:---|
| RC-09 | **時系列表示** | 患者詳細ページで記録一覧を確認する。 | ・記録が日付の降順（新しい順）で表示される。 |
| RC-10 | **概要表示** | 記録一覧の各カードを確認する。 | ・日付、主訴の冒頭、担当者名が表示される。 |
| RC-11 | **詳細展開** | 記録カードをクリックまたは展開ボタンを押す。 | ・SOAP全文が表示される。 |

---

## 4. AI取込機能 (AI Import)

| ID | 項目 | 手順 / 条件 | 期待される挙動 |
|:---|:---|:---|:---|
| AI-01 | **ガイド表示** | 記録作成フォームの「AI取込」ボタンをクリックする。 | ・AI取込ガイドモーダルが表示される。<br>・プロンプト例が表示される。 |
| AI-02 | **テキスト貼り付け** | AIからのレスポンス（JSON形式）を入力欄に貼り付ける。 | ・JSON形式として認識される。 |
| AI-03 | **フィールド自動展開** | 正しい形式のJSONを取り込む。 | ・S/O/A/Pの各フィールドに自動的に値が入力される。 |
| AI-04 | **エラーハンドリング** | 不正な形式のテキストを貼り付ける。 | ・エラーメッセージが表示される。<br>・既存の入力内容が消えない。 |

---

## 5. 画像添付プラグイン (Attachments)

> ⚠️ 本機能は `NEXT_PUBLIC_ATTACHMENTS_ENABLED=true` の場合のみ有効です。

| ID | 項目 | 手順 / 条件 | 期待される挙動 |
|:---|:---|:---|:---|
| AT-01 | **ボタン表示** | プラグイン有効時、記録カードを確認する。 | ・📷（カメラ）ボタンが表示される。 |
| AT-02 | **アップロードモーダル** | 📷ボタンをクリックする。 | ・画像アップロードモーダルが表示される。 |
| AT-03 | **画像アップロード** | 画像ファイル（JPG/PNG）を選択してアップロードする。 | ・アップロードが成功する。<br>・サムネイルがギャラリーに表示される。 |
| AT-04 | **拡大表示** | サムネイルをクリックする。 | ・画像が拡大表示される。 |
| AT-05 | **画像削除** | ギャラリー内の削除ボタンをクリックする。 | ・確認ダイアログが表示される。<br>・確定後、画像が削除される。 |
| AT-06 | **サイズ制限** | 10MBを超える画像をアップロードしようとする。 | ・エラーメッセージが表示される。<br>・アップロードがブロックされる。 |

---

## 6. 操作者追跡 (Operator Tracking)

| ID | 項目 | 手順 / 条件 | 期待される挙動 |
|:---|:---|:---|:---|
| OT-01 | **作成者記録** | 認証有効状態で記録を作成する。 | ・`createdBy` にログインユーザーのIDが記録される。 |
| OT-02 | **作成者表示** | 記録詳細を表示する。 | ・「記録者: ○○ さん」「記録日時: YYYY-MM-DD HH:mm」が表示される。 |
| OT-03 | **更新者記録** | 別のユーザーで記録を編集・保存する。 | ・`updatedBy` に編集者のIDが記録される。 |

---

## ✅ テスト実施記録

| ID | 結果 | 実施日時 | 実施者 | 備考 |
|:---|:---:|:---|:---|:---|
| RC-01 | ✅ | 2025-12-15 12:00 | System | Browser Automation (Embedded Form) |
| RC-02 | ⬜ | - | - | - |
| RC-03 | ⬜ | - | - | - |
| RC-04 | ✅ | 2025-12-15 12:00 | System | Browser Automation |
| RC-05 | ⬜ | - | - | - |
| RC-06 | ⬜ | - | - | - |
| RC-07 | ⬜ | - | - | - |
| RC-08 | ⬜ | - | - | - |
| RC-09 | ⬜ | - | - | - |
| RC-10 | ⬜ | - | - | - |
| RC-11 | ⬜ | - | - | - |
| AI-01 | ⬜ | - | - | - |
| AI-02 | ⬜ | - | - | - |
| AI-03 | ⬜ | - | - | - |
| AI-04 | ⬜ | - | - | - |
| AT-01 | ⬜ | - | - | - |
| AT-02 | ⬜ | - | - | - |
| AT-03 | ⬜ | - | - | - |
| AT-04 | ⬜ | - | - | - |
| AT-05 | ⬜ | - | - | - |
| AT-06 | ⬜ | - | - | - |
| OT-01 | ⬜ | - | - | - |
| OT-02 | ⬜ | - | - | - |
| OT-03 | ⬜ | - | - | - |

**凡例**: ✅ = 通過 / ❌ = 失敗 / ⬜ = 未実施

