# 🧪 動作確認手順書: 設定/認証 (Settings & Authentication)

## 📌 概要
本ドキュメントは、設定画面（`/settings`）、認証機能、バックアップ機能の動作確認手順と期待される挙動を定義します。

---

## 1. スタッフ管理 (Staff Management)

| ID | 項目 | 手順 / 条件 | 期待される挙動 |
|:---|:---|:---|:---|
| ST-01 | **一覧表示** | 設定画面のスタッフタブを開く。 | ・登録済みスタッフの一覧が表示される。<br>・名前、役割、ステータス（有効/無効）が表示される。 |
| ST-02 | **新規登録** | 「スタッフ追加」ボタンをクリックし、名前・役割を入力して保存。 | ・新しいスタッフが一覧に追加される。 |
| ST-03 | **編集** | 既存スタッフの「編集」ボタンをクリックして名前を変更し保存。 | ・変更が反映される。 |
| ST-04 | **無効化** | スタッフの「無効化」ボタンをクリックする。 | ・スタッフが無効状態になる。<br>・予約作成時の担当者選択肢から除外される。 |
| ST-05 | **有効化** | 無効化されたスタッフの「有効化」ボタンをクリックする。 | ・スタッフが有効状態に戻る。<br>・担当者選択肢に復活する。 |
| ST-06 | **役割選択** | スタッフ登録/編集時に役割（Director/Therapist/Clerk/Other）を選択する。 | ・選択した役割が保存される。 |

---

## 2. PIN認証 (Authentication)

> ⚠️ 本機能は `AUTH_ENABLED=true` の場合のみ有効です。

### 2-1. ログイン
| ID | 項目 | 手順 / 条件 | 期待される挙動 |
|:---|:---|:---|:---|
| AU-01 | **ログイン画面表示** | 認証有効状態で未ログイン時にアプリにアクセスする。 | ・ログイン画面が表示される。<br>・スタッフ選択とPIN入力欄が表示される。 |
| AU-02 | **スタッフ選択** | ドロップダウンからスタッフを選択する。 | ・選択したスタッフ名が表示される。 |
| AU-03 | **PIN入力** | 正しいPINを入力してログインボタンをクリックする。 | ・ログイン成功。<br>・ダッシュボードに遷移する。 |
| AU-04 | **PIN誤り** | 不正なPINを入力してログインを試みる。 | ・エラーメッセージが表示される。<br>・ログインできない。 |

### 2-2. ログアウト
| ID | 項目 | 手順 / 条件 | 期待される挙動 |
|:---|:---|:---|:---|
| AU-05 | **ログアウト実行** | ヘッダーのユーザーメニューから「ログアウト」をクリックする。 | ・セッションがクリアされる。<br>・ログイン画面にリダイレクトされる。 |

### 2-3. セッション維持
| ID | 項目 | 手順 / 条件 | 期待される挙動 |
|:---|:---|:---|:---|
| AU-06 | **リロード後維持** | ログイン後、ブラウザをリロードする。 | ・ログイン状態が維持される。<br>・再度ログイン画面は表示されない。 |
| AU-07 | **ブラウザ終了後** | ログイン後、ブラウザを完全に閉じて再度開く。 | ・（実装依存）セッションが維持される、または再ログインが必要。 |

---

## 3. プラグイン設定 (Plugin Settings)

| ID | 項目 | 手順 / 条件 | 期待される挙動 |
|:---|:---|:---|:---|
| PL-01 | **設定画面表示** | 設定画面の「プラグイン設定」セクションを開く。 | ・現在のプラグイン設定（ON/OFF）が表示される。 |
| PL-02 | **画像添付トグル** | 画像添付機能のトグルをONにする。 | ・設定が保存される。<br>・即座に記録画面に📷ボタンが表示される。 |
| PL-03 | **設定永続化** | プラグイン設定を変更後、ブラウザをリロードする。 | ・設定が維持される（DBに保存されている）。 |
| PL-04 | **環境変数優先順位** | DBに設定がない場合、環境変数の値を確認する。 | ・環境変数がデフォルト値として使用される。<br>・DBに値を保存すると、DB設定が優先される。 |

---

## 4. バックアップ機能 (Backup)

### 4-1. 手動ダウンロード（Web版）
| ID | 項目 | 手順 / 条件 | 期待される挙動 |
|:---|:---|:---|:---|
| BK-01 | **ダウンロードボタン** | 設定画面の「データバックアップ」セクションで「ダウンロード」ボタンをクリックする。 | ・データベースファイル（.db）がダウンロードされる。<br>・ファイル名に日時が含まれる。 |

### 4-2. 自動バックアップ（Electron版のみ）
| ID | 項目 | 手順 / 条件 | 期待される挙動 |
|:---|:---|:---|:---|
| BK-02 | **起動時バックアップ** | Electronアプリを起動する。 | ・自動でバックアップが作成される。<br>・バックアップフォルダに新しいファイルが追加される。 |
| BK-03 | **終了時バックアップ** | Electronアプリを終了する。 | ・自動でバックアップが作成される。 |
| BK-04 | **ローテーション** | バックアップが10件を超える状態にする。 | ・古いバックアップが自動削除され、最新10件が保持される。 |

### 4-3. バックアップ復元（Electron版のみ）
| ID | 項目 | 手順 / 条件 | 期待される挙動 |
|:---|:---|:---|:---|
| BK-05 | **復元一覧表示** | 設定画面の「自動バックアップ管理」セクションを開く。 | ・バックアップファイルの一覧が表示される。<br>・各ファイルの日時が表示される。 |
| BK-06 | **復元実行** | 復元したいバックアップの「復元」ボタンをクリックする。 | ・確認ダイアログが表示される。 |
| BK-07 | **復元確定** | 確認ダイアログで「はい」をクリックする。 | ・復元前に安全バックアップ（pre-restore-*.db）が作成される。<br>・データベースが復元される。<br>・アプリが自動再起動する。 |
| BK-08 | **復元後データ確認** | 復元後、アプリでデータを確認する。 | ・バックアップ時点のデータに戻っている。 |

---

## 5. システム設定表示

| ID | 項目 | 手順 / 条件 | 期待される挙動 |
|:---|:---|:---|:---|
| SY-01 | **設定画面遷移** | ヘッダーの「設定」リンクをクリックする。 | ・設定画面（`/settings`）に遷移する。 |
| SY-02 | **タブ切り替え** | スタッフ管理/プラグイン設定/バックアップの各タブを切り替える。 | ・各セクションに正しく遷移する。 |

---

## 6. 環境依存機能の表示制御

| ID | 項目 | 手順 / 条件 | 期待される挙動 |
|:---|:---|:---|:---|
| ENV-01 | **Electron専用表示** | Web版で設定画面を開く。 | ・「自動バックアップ管理」セクションが表示されない。 |
| ENV-02 | **Electron環境表示** | Electron版で設定画面を開く。 | ・「自動バックアップ管理」セクションが表示される。 |
| ENV-03 | **認証無効時** | `AUTH_ENABLED=false` でアプリにアクセスする。 | ・ログイン画面が表示されず、直接ダッシュボードが開く。<br>・ヘッダーにユーザー情報が表示されない（またはデフォルト表示）。 |

---

## ✅ テスト実施記録

| ID | 結果 | 実施日時 | 実施者 | 備考 |
|:---|:---:|:---|:---|:---|
| ST-01 | ✅ | 2025-12-15 12:50 | System | Browser Automation |
| ST-02 | ✅ | 2025-12-15 12:50 | System | Browser Automation |
| ST-03 | ✅ | 2025-12-15 12:50 | System | Browser Automation |
| ST-04 | ✅ | 2025-12-15 12:50 | System | Browser Automation |
| ST-05 | ✅ | 2025-12-15 12:50 | System | Browser Automation |
| ST-06 | ✅ | 2025-12-15 12:50 | System | Browser Automation |
| AU-01 | ⬜ | - | - | - |
| AU-02 | ⬜ | - | - | - |
| AU-03 | ⬜ | - | - | - |
| AU-04 | ⬜ | - | - | - |
| AU-05 | ⬜ | - | - | - |
| AU-06 | ⬜ | - | - | - |
| AU-07 | ⬜ | - | - | - |
| PL-01 | ✅ | 2025-12-15 12:50 | System | Browser Automation |
| PL-02 | ✅ | 2025-12-15 12:50 | System | Browser Automation |
| PL-03 | ✅ | 2025-12-15 12:50 | System | Browser Automation |
| PL-04 | ✅ | 2025-12-15 12:50 | System | Browser Automation |
| BK-01 | ✅ | 2025-12-15 12:50 | System | Browser Automation (Button Check) |
| BK-02 | ⬜ | - | - | - |
| BK-03 | ⬜ | - | - | - |
| BK-04 | ⬜ | - | - | - |
| BK-05 | ⬜ | - | - | - |
| BK-06 | ⬜ | - | - | - |
| BK-07 | ⬜ | - | - | - |
| BK-08 | ⬜ | - | - | - |
| SY-01 | ✅ | 2025-12-15 12:50 | System | Browser Automation |
| SY-02 | ✅ | 2025-12-15 12:50 | System | Browser Automation |
| ENV-01 | ✅ | 2025-12-15 12:50 | System | Browser Automation |
| ENV-02 | ⬜ | - | - | Electron Only |
| ENV-03 | ⬜ | - | - | - |

**凡例**: ✅ = 通過 / ❌ = 失敗 / ⬜ = 未実施

